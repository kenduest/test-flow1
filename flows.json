[{"id":"1bd17114.208f7f","type":"tab","label":"流程1","disabled":false,"info":""},{"id":"3fc67bb7.c65944","type":"tab","label":"流程2","disabled":false,"info":""},{"id":"a2178b87.7d7a9","type":"tab","label":"流程3","disabled":false,"info":""},{"id":"8d2d215.047b26","type":"Gravity Server","server":"gravity2-nats","port":"4222"},{"id":"6d06e8a0.db70f","type":"Gravity Server","server":"gravity1-nats","port":"4222"},{"id":"f04213fa.c22b48","type":"MSSQL-CN","tdsVersion":"7_4","name":"Target MSSQL","server":"target-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"Brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","enableArithAbort":true},{"id":"2ca87b75.cb01dc","type":"MSSQL-CN","tdsVersion":"7_4","name":"MSSQL Source #1","server":"source-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","enableArithAbort":true},{"id":"d5cda53a.b9005","type":"MSSQL-CN","tdsVersion":"7_4","name":"MSSQL Source #2","server":"source-mssql2.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"Brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","enableArithAbort":true},{"id":"ce7c2fc5.bbfd68","type":"Gravity Subscriber","z":"1bd17114.208f7f","name":"Gravity1 Source Event","server":"6d06e8a0.db70f","subscriberID":"","enabledAuth":false,"initialLoad":false,"collections":[],"x":160,"y":1080,"wires":[["5e997637.8b4f58","fcaf454e.703438"]]},{"id":"f899a01d.1d8258","type":"debug","z":"1bd17114.208f7f","name":"Debug HTTP","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1110,"y":1720,"wires":[]},{"id":"950ff7.f5988808","type":"http request","z":"1bd17114.208f7f","name":"Message API POST","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://message-api.gfactor.svc.cluster.local/message-api/v1/notificationx","tls":"","persist":true,"proxy":"","authType":"","x":830,"y":1500,"wires":[["206a78b0.d9321","f899a01d.1d8258"]]},{"id":"5e997637.8b4f58","type":"debug","z":"1bd17114.208f7f","name":"Debug NATS1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":380,"y":820,"wires":[]},{"id":"fcaf454e.703438","type":"switch","z":"1bd17114.208f7f","name":"Check Event","property":"payload.eventName","propertyType":"msg","rules":[{"t":"eq","v":"DeliveryPoolCreate","vt":"str"},{"t":"eq","v":"DeliveryPoolDelete","vt":"str"},{"t":"eq","v":"DeliveryPoolUpdate","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":390,"y":1200,"wires":[["10915f53.5494e1"],[],[]]},{"id":"205d0e4c.77c1ba","type":"debug","z":"1bd17114.208f7f","name":"Debug DataFormater","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":740,"y":820,"wires":[]},{"id":"10915f53.5494e1","type":"function","z":"1bd17114.208f7f","name":"Create Full API Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nmsg.data_is_expired=0\n\nBookingTime=new Date(msg.payload.message.BookingTime)\n\nif (msg.payload.message.ExpireTime == null || \n    msg.payload.message.ExpireTime <= 0)  {\n    NewExpireTime = null\n   } \n\nelse {\n    CurrentTime = new Date()\n    ExpireTime = msg.payload.message.ExpireTime\n    t1 = new Date(BookingTime.getTime() +  ExpireTime * 1000)\n\n    if (CurrentTime >= ExpireTime) {\n        msg.data_is_expired=1\n    }\n\n    year = t1.getFullYear().zeroPad(1000).toString()\n    month = (t1.getMonth() + 1).zeroPad(10).toString()\n    day = t1.getDate().zeroPad(10).toString()\n    hour = t1.getHours().zeroPad(10).toString()\n    minute = t1.getMinutes().zeroPad(10).toString()\n    second = t1.getSeconds().zeroPad(10).toString()\n    NewExpireTime = year + month + day + hour + minute + second\n}\n\n\nNewPayload = {\n    \"priority\": msg.payload.message.Priority || 9,\n    \"expireTime\": NewExpireTime,\n    \"msgType\": msg.payload.message.MsgType || null,\n    \"reqDepartment\": msg.payload.message.DepID || null,\n    \"reqBu\": msg.payload.message.Bu || null,\n    \"reqCompany\": msg.payload.message.Company || null,\n    \"reqChannel\": msg.payload.message.Channel || null,\n    \"reqObjectId\": msg.payload.message.ObjectID || null,\n    \"memo\": msg.payload.message.Memo || null,\n    \"content\": msg.payload.message.MsgData,\n    \"data\": [ {\n        \"customerPhone\": msg.payload.message.MPhoneNum,\n        \"customerId\": msg.payload.message.SenderID ,\n        \"customerReference\": msg.payload.message.Reference || null,\n        \"reqGroupId\": msg.payload.message.GroupID || null,\n        }\n    ]\n}\n\n\nmsg.deliveryUID = msg.payload.message.UID\nmsg.api_payload = NewPayload\nmsg.retry = 0\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":1000,"wires":[["205d0e4c.77c1ba","701a891f.13c298"]]},{"id":"fc7a311c.a37b88","type":"Gravity Subscriber","z":"3fc67bb7.c65944","name":"Gravity2 Source","server":"8d2d215.047b26","subscriberID":"","enabledAuth":false,"initialLoad":false,"collections":[],"x":160,"y":740,"wires":[["fbb24445.6bca58","5cc04d0b.fdd6d4"]]},{"id":"fbb24445.6bca58","type":"debug","z":"3fc67bb7.c65944","name":"Debug Gravity2 NATS","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":440,"y":520,"wires":[]},{"id":"998b6718.c755e8","type":"inject","z":"3fc67bb7.c65944","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Inject","payloadType":"str","x":970,"y":1020,"wires":[["3f6cf3b6.f087e4"]]},{"id":"3f6cf3b6.f087e4","type":"function","z":"3fc67bb7.c65944","name":"Insert Data","func":"\n\nmsg.payload = \"INSERT INTO [dbo].[send_record](customer_phone,content) values('12345678','content')\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1270,"y":1020,"wires":[[]]},{"id":"6fed29fb.d96088","type":"function","z":"3fc67bb7.c65944","name":"Select Data","func":"\n\nmsg.payload = \"SELECT * from [dbo].[send_record]\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1310,"y":500,"wires":[[]]},{"id":"5cc04d0b.fdd6d4","type":"sqlbuilder","z":"3fc67bb7.c65944","name":"Compose Event Data","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nBookingTime=new Date(msg.payload.message.BookingTime)\nExpireTime = msg.payload.message.ExpireTime\nt1 = new Date(BookingTime.getTime() +  ExpireTime * 1000)\nyear = t1.getFullYear().zeroPad(1000).toString()\nmonth = (t1.getMonth() + 1).zeroPad(10).toString()\nday = t1.getDate().zeroPad(10).toString()\nhour = t1.getHours().zeroPad(10).toString()\nminute = t1.getMinutes().zeroPad(10).toString()\nsecond = t1.getSeconds().zeroPad(10).toString()\n\nNewExpireTime = year + month + day + hour + minute + second\n\n\n// ----------------------------------------------------------\n// send table\n// ----------------------------------------------------------\n\nquery.insert(\n    {\n        customer_phone: msg.payload.message.MPhoneNum,\n        content: msg.payload.message.MsgData,\n        send_time: BookingTime,\n        expire_time: NewExpireTime,\n        customer_id: msg.payload.message.SenderID,\n        customer_reference: msg.payload.message.Reference,\n        calc_section: send_record_calc_section,\n        status:0\n        \n    }\n).into('send_record').returning('uid')\n\n\n// send_record table\n\n\nsend_record_calc_section = Math.ceil(content.length / 70)\n\n\n\n\nquery.insert(\n    {\n        customer_phone: msg.payload.message.MPhoneNum,\n        content: msg.payload.message.MsgData,\n        send_time: BookingTime,\n        expire_time: NewExpireTime,\n        customer_id: msg.payload.message.SenderID,\n        customer_reference: msg.payload.message.Reference,\n        calc_section: send_record_calc_section,\n        status:0\n        \n    }\n).into('send_record').returning('uid')\n\n\n\nrandomID = Math.round(Math.random())\n\n","x":620,"y":740,"wires":[["eeb90633.aa994"]]},{"id":"1ad7bc7c.be29c4","type":"sqlbuilder","z":"1bd17114.208f7f","name":"Update Result Delivery Log","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"\n// =====================================================\n// 說明\n//\n// Table: HandleDeliveryPool, 記錄 API 溝通失敗需要再次處理簡訊\n//\n\nTABLE_NAME = \"DeliveryResultLog\"\n\nquery.insert(\n    { DeliveryPoolUID: msg.deliveryUID, Status: 0 }\n).into(\"DeliveryResultLog\")\n","x":1660,"y":1700,"wires":[["9d2169ca.165e48"]]},{"id":"206a78b0.d9321","type":"switch","z":"1bd17114.208f7f","name":"Check API Response","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1140,"y":1500,"wires":[["4f24e51b.ad8ed4","c1c329e8.0cbb3"],[]]},{"id":"3316cc30.3916cc","type":"inject","z":"3fc67bb7.c65944","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Inject","payloadType":"str","x":1010,"y":500,"wires":[["6fed29fb.d96088"]]},{"id":"eeb90633.aa994","type":"function","z":"3fc67bb7.c65944","name":"DB TRANSACTION","func":"\n\nmsg.payload = \"BEGIN TRANSACTION\\n\" + msg.payload + \"COMMIT TRANSACTION\"\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":1160,"wires":[[]]},{"id":"45b6e2c2.012a04","type":"debug","z":"3fc67bb7.c65944","name":"DB TRANSACTION DEBUG","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1820,"y":1420,"wires":[]},{"id":"f07c0e4f.2f15f","type":"sqlbuilder","z":"1bd17114.208f7f","name":"Update handle Delivery","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"\n// =====================================================\n// 說明\n//\n// Table: HandleDeliveryPool, 記錄 API 溝通失敗需要再次處理簡訊\n//\n//\n// =====================================================\n\n\n// ------------------------\n// 產生再次處理的資訊\n// ------------------------\n\nTABLE_NAME = 'HandleDeliveryPool'\n\n\nquery.insert(\n    { DeliveryPoolUID: msg.deliveryUID } ).into(TABLE_NAME)\n\n\n","x":1550,"y":1040,"wires":[["d57cf86f.f82868"]]},{"id":"e4c78794.60b02","type":"http request","z":"a2178b87.7d7a9","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://google.com/xxx","tls":"","persist":false,"proxy":"","authType":"","x":840,"y":700,"wires":[["fbab5c4c.b2f808"]]},{"id":"16e230dd.1abc77","type":"inject","z":"a2178b87.7d7a9","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":700,"wires":[["4c86cd88.001554"]]},{"id":"af02c4bd.3d0698","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1630,"y":1140,"wires":[]},{"id":"4c86cd88.001554","type":"function","z":"a2178b87.7d7a9","name":"create data","func":"msg.payload = { 'xx': Date().toString() }\nmsg.retry = 0\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":700,"wires":[["e4c78794.60b02"]]},{"id":"cba5ee67.f436a8","type":"counter-loop","z":"a2178b87.7d7a9","name":"For loop","counter":"retry","counterType":"msg","reset":false,"resetValue":"value-null","initial":0,"initialType":"num","operator":"gt","termination":"3","terminationType":"num","increment":1,"incrementType":"num","x":1200,"y":840,"wires":[["77524b77.59eb2c"],[]]},{"id":"77524b77.59eb2c","type":"http request","z":"a2178b87.7d7a9","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://google.com","tls":"","persist":false,"proxy":"","authType":"","x":1200,"y":1120,"wires":[["af02c4bd.3d0698","cba5ee67.f436a8"]]},{"id":"fbab5c4c.b2f808","type":"switch","z":"a2178b87.7d7a9","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":700,"wires":[["cba5ee67.f436a8"]]},{"id":"c1c329e8.0cbb3","type":"counter-loop","z":"1bd17114.208f7f","name":"API Request loop","counter":"retry","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lte","termination":"3","terminationType":"num","increment":1,"incrementType":"num","x":1170,"y":1080,"wires":[["f07c0e4f.2f15f","4c213581.fc312c"],[]]},{"id":"97c7cd51.742fb","type":"function","z":"1bd17114.208f7f","name":"Create API PayLoad","func":"msg.payload = msg.api_payload\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":1500,"wires":[["950ff7.f5988808","5ab3489f.ec68d8"]]},{"id":"4f24e51b.ad8ed4","type":"function","z":"1bd17114.208f7f","name":"Reset Loop","func":"msg.retry = null\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1370,"y":1620,"wires":[["1ad7bc7c.be29c4"]]},{"id":"5ab3489f.ec68d8","type":"debug","z":"1bd17114.208f7f","name":"Debug DataFormater","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":840,"y":1720,"wires":[]},{"id":"4c213581.fc312c","type":"sqlbuilder","z":"1bd17114.208f7f","name":"Update Result Delivery Log","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"\n// =====================================================\n// 說明\n//\n// Table: HandleDeliveryPool, 記錄 API 溝通失敗需要再次處理簡訊\n//\n\nTABLE_NAME = \"DeliveryResultLog\"\n\nquery.insert(\n    { DeliveryPoolUID: msg.deliveryUID, Status: 1 }\n).into(\"DeliveryResultLog\")\n","x":1560,"y":1120,"wires":[["2723c95c.a7b486"]]},{"id":"73a6688c.6200a","type":"debug","z":"1bd17114.208f7f","name":"Debug Source DB Err","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"err","targetType":"msg","statusVal":"","statusType":"auto","x":2700,"y":1180,"wires":[]},{"id":"d57cf86f.f82868","type":"counter-loop","z":"1bd17114.208f7f","name":"DB Access For loop","counter":"db_fail_retry1","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"5","terminationType":"num","increment":1,"incrementType":"num","x":1860,"y":1040,"wires":[["fea294d4.20f6e"],[]]},{"id":"2723c95c.a7b486","type":"counter-loop","z":"1bd17114.208f7f","name":"DB Access For loop","counter":"db_fail_retry2","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"5","terminationType":"num","increment":1,"incrementType":"num","x":1860,"y":1120,"wires":[["fea294d4.20f6e"],[]]},{"id":"9d2169ca.165e48","type":"counter-loop","z":"1bd17114.208f7f","name":"DB Access For loop","counter":"db_success_retry","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"5","terminationType":"num","increment":1,"incrementType":"num","x":1980,"y":1700,"wires":[["1ba8563b.b6083a"],[]]},{"id":"5704a15e.059f2","type":"function","z":"1bd17114.208f7f","name":"Reset Loop","func":"msg.db_fail_retry2 = null\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1990,"y":1480,"wires":[[]]},{"id":"7f06dd8d.3f46fc","type":"switch","z":"1bd17114.208f7f","name":"Check DB Update","property":"err","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1630,"y":1480,"wires":[["2723c95c.a7b486"],["5704a15e.059f2"]]},{"id":"98a0a6a0.d2787","type":"switch","z":"1bd17114.208f7f","name":"Check DB Update","property":"err","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2590,"y":900,"wires":[["fc429c2.4964b6"],["7e7acced.d964c4"]]},{"id":"7e7acced.d964c4","type":"function","z":"1bd17114.208f7f","name":"Reset Loop","func":"msg.db_fail_retry1 = null\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2830,"y":980,"wires":[[]]},{"id":"1baaa200.689afe","type":"function","z":"1bd17114.208f7f","name":"Reset Loop","func":"msg.db_success_retry = null\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2590,"y":1960,"wires":[[]]},{"id":"6187be3f.b0ad9","type":"switch","z":"1bd17114.208f7f","name":"Check DB Update","property":"err","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2290,"y":1960,"wires":[["6a7435bc.cf2e34"],["1baaa200.689afe"]]},{"id":"1ba8563b.b6083a","type":"function","z":"1bd17114.208f7f","name":"Console DB Error Log","func":"node.error(msg.err)","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2280,"y":1540,"wires":[[]]},{"id":"fea294d4.20f6e","type":"function","z":"1bd17114.208f7f","name":"Console DB Error Log","func":"node.error(msg.err)","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2380,"y":1060,"wires":[[]]},{"id":"fc429c2.4964b6","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1620,"y":840,"wires":[["d57cf86f.f82868"]]},{"id":"6a7435bc.cf2e34","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1720,"y":1900,"wires":[["9d2169ca.165e48"]]},{"id":"8eabc318.d37b4","type":"sqlbuilder","z":"3fc67bb7.c65944","name":"Update Result Delivery Log","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"\n// =====================================================\n// 說明\n//\n// Table: HandleDeliveryPool, 記錄 API 溝通失敗需要再次處理簡訊\n//\n\nTABLE_NAME = \"DeliveryResultLog\"\n\nquery.insert(\n    { DeliveryPoolUID: msg.deliveryUID, Status: 0 }\n).into(\"DeliveryResultLog\")\n","x":1060,"y":1220,"wires":[["93eec42a.c9901"]]},{"id":"93eec42a.c9901","type":"counter-loop","z":"3fc67bb7.c65944","name":"DB Access For loop","counter":"db_success_retry","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"5","terminationType":"num","increment":1,"incrementType":"num","x":1480,"y":1220,"wires":[["74947a2d.69233c"],[]]},{"id":"80305577.273e08","type":"function","z":"3fc67bb7.c65944","name":"Reset Loop","func":"msg.db_success_retry = null\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2090,"y":1480,"wires":[[]]},{"id":"c6c2a4f4.115178","type":"switch","z":"3fc67bb7.c65944","name":"Check DB Update","property":"err","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1790,"y":1480,"wires":[["22644e75.6569e2"],["80305577.273e08"]]},{"id":"74947a2d.69233c","type":"function","z":"3fc67bb7.c65944","name":"Console DB Error Log","func":"node.error(msg.err)","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1780,"y":1060,"wires":[[]]},{"id":"22644e75.6569e2","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1220,"y":1420,"wires":[["93eec42a.c9901"]]},{"id":"1be26bb0.caab9c","type":"counter-loop","z":"1bd17114.208f7f","name":"DB Access For loop","counter":"db_fail_retry0","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lte","termination":"3","terminationType":"num","increment":1,"incrementType":"num","x":1260,"y":520,"wires":[["c498cf27.baf6e"],["a4686f76.2b462"]]},{"id":"c498cf27.baf6e","type":"function","z":"1bd17114.208f7f","name":"Console DB Expired Error Log Finally","func":"error_message = \"Could not write expired data log finally: \" + msg.error\n\nnode.error(error_message, msg)\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1510,"y":260,"wires":[[]]},{"id":"701a891f.13c298","type":"switch","z":"1bd17114.208f7f","name":"Check Expired","property":"data_is_expired","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":920,"y":1000,"wires":[["1be26bb0.caab9c"],["c1c329e8.0cbb3"]]},{"id":"f97acbf3.a801b8","type":"comment","z":"1bd17114.208f7f","name":"Comment","info":"DB Status\n1. Value 0: Success\n2. Value 1: API Access Error\n3. Value 2: Data is Expired","x":160,"y":1720,"wires":[]},{"id":"95a1dcb7.586838","type":"inject","z":"a2178b87.7d7a9","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Inject","payloadType":"str","x":350,"y":1520,"wires":[["a4b3e191.8e4d3"]]},{"id":"a4b3e191.8e4d3","type":"sqlbuilder","z":"a2178b87.7d7a9","name":"Query DeliveryResultLog Table","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"query.select(\"*\").from(\"DeliveryResultLog\")\n","x":630,"y":1520,"wires":[["b9eeb915.0cc6f"]]},{"id":"5fbd7021.c5ea2","type":"sqlbuilder","z":"a2178b87.7d7a9","name":"Query HandleDeliveryPool Table","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"query.select(\"*\").from(\"HandleDeliveryPool\")\n","x":630,"y":1600,"wires":[["b9eeb915.0cc6f"]]},{"id":"303194a.d18236c","type":"inject","z":"a2178b87.7d7a9","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Inject","payloadType":"str","x":350,"y":1600,"wires":[["5fbd7021.c5ea2"]]},{"id":"e11a7961.e683d8","type":"debug","z":"a2178b87.7d7a9","name":"Debug Source DB Err","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"err","targetType":"msg","statusVal":"","statusType":"auto","x":1280,"y":1340,"wires":[]},{"id":"2dea79f.d013c06","type":"debug","z":"1bd17114.208f7f","name":"Debug Source DB Err","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"err","targetType":"msg","statusVal":"","statusType":"auto","x":2860,"y":780,"wires":[]},{"id":"bf31eef1.bc1cb8","type":"function","z":"1bd17114.208f7f","name":"Handle for db write","func":"if ( (msg.error == null) || (msg.error == \"\") ) {\n    msg.result = \"Write Expire Log success\"\n\n} else {\n    msg.result = \"Write Expire Log failure\"\n    sleep(1000); // sleep 1\n}\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1870,"y":300,"wires":[["5b2c599a.76ffa8","1be26bb0.caab9c"]]},{"id":"e925a296.280708","type":"function","z":"a2178b87.7d7a9","name":"","func":"node.error('EEEE')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1500,"y":1460,"wires":[[]]},{"id":"db7efe77.1508f8","type":"catch","z":"a2178b87.7d7a9","name":"","scope":["7889acb2.e45304"],"uncaught":false,"x":770,"y":1800,"wires":[["ee377bf9.0bc348"]]},{"id":"2bd6810d.e22ece","type":"catch","z":"a2178b87.7d7a9","name":"","scope":["2c94a22c.91012e"],"uncaught":false,"x":170,"y":1300,"wires":[["1b335a4f.1ca0b6","c2ade397.70a2d8"]]},{"id":"2c94a22c.91012e","type":"function","z":"a2178b87.7d7a9","name":"Random Throw Error","func":"node.error(\"XXXan example error: \");   \nreturn msg\n\nmsg.info = \"XXX\"\nmsg.il5a0b3227249654 = null\nif (Math.random() * 100 <= 50 ) {\nnode.error(\"XXXan example error: \");   \n}\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":860,"wires":[["9b74ebc8.3b67a","c2ade397.70a2d8"]]},{"id":"d16b9fac.8212a","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1020,"y":1260,"wires":[]},{"id":"c5ee9670.5dbbd8","type":"inject","z":"a2178b87.7d7a9","name":"Trigger error","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":1080,"wires":[["c2ade397.70a2d8"]]},{"id":"ee377bf9.0bc348","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1180,"y":1840,"wires":[]},{"id":"b9eeb915.0cc6f","type":"counter-loop","z":"a2178b87.7d7a9","name":"","counter":"ilb9eeb9150cc6f","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"3","terminationType":"num","increment":1,"incrementType":"num","x":930,"y":1560,"wires":[["ee377bf9.0bc348"],["59f42509.50ee7c"]]},{"id":"b02773c1.e266b8","type":"debug","z":"a2178b87.7d7a9","name":"output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1990,"y":1820,"wires":[]},{"id":"c18d22cc.a63ca","type":"inject","z":"a2178b87.7d7a9","name":"open","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"open","payloadType":"str","x":1670,"y":1680,"wires":[["99687dff.3ddd7"]]},{"id":"f8668471.4f45f8","type":"inject","z":"a2178b87.7d7a9","name":"input","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1610,"y":1820,"wires":[["99687dff.3ddd7"]]},{"id":"56c10d38.aa25c4","type":"inject","z":"a2178b87.7d7a9","name":"trigger","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"trigger","payloadType":"str","x":1670,"y":1760,"wires":[["99687dff.3ddd7"]]},{"id":"c6fce5f0.0ad3b8","type":"inject","z":"a2178b87.7d7a9","name":"flush","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"flush","payloadType":"str","x":1670,"y":1720,"wires":[["99687dff.3ddd7"]]},{"id":"5d45eb15.7a02e4","type":"inject","z":"a2178b87.7d7a9","name":"queue","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"queue","payloadType":"str","x":1670,"y":1880,"wires":[["99687dff.3ddd7"]]},{"id":"8bc7606f.d8fed","type":"inject","z":"a2178b87.7d7a9","name":"default","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"default","payloadType":"str","x":1670,"y":1920,"wires":[["99687dff.3ddd7"]]},{"id":"99687dff.3ddd7","type":"q-gate","z":"a2178b87.7d7a9","name":"","controlTopic":"control","defaultState":"queueing","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","queueCmd":"queue","defaultCmd":"default","triggerCmd":"trigger","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","statusCmd":"status","maxQueueLength":"1","keepNewest":true,"qToggle":false,"persist":false,"x":1860,"y":1820,"wires":[["b02773c1.e266b8"]]},{"id":"c2ade397.70a2d8","type":"counter-loop","z":"a2178b87.7d7a9","name":"","counter":"il5a0b3227249654","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"10","terminationType":"num","increment":1,"incrementType":"num","x":460,"y":1080,"wires":[[],["2c94a22c.91012e"]]},{"id":"1b335a4f.1ca0b6","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":620,"y":1300,"wires":[]},{"id":"9b74ebc8.3b67a","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"info","targetType":"msg","statusVal":"","statusType":"auto","x":800,"y":1220,"wires":[]},{"id":"918706ac.7bd8c8","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"d5cda53a.b9005","name":"","outField":"payload","returnType":0,"throwErrors":1,"query":"","modeOpt":"queryMode","modeOptType":"query","queryOpt":"payload","queryOptType":"editor","paramsOpt":"queryParams","paramsOptType":"none","rows":"rows","rowsType":"msg","params":[],"x":2370,"y":1320,"wires":[[]]},{"id":"a4686f76.2b462","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"2ca87b75.cb01dc","name":"MSSQL Source For Error","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[DXeliveryResultLog](DeliveryPoolUID,Status ) VALUES(@DeliveryPoolUID, @Status)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"int","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Status","type":"int","valueType":"num","value":"2","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1660,"y":620,"wires":[["bf31eef1.bc1cb8","b9fd2aae.207e58"]]},{"id":"59f42509.50ee7c","type":"MSSQL","z":"a2178b87.7d7a9","mssqlCN":"2ca87b75.cb01dc","name":"","outField":"payload","returnType":0,"throwErrors":1,"query":"","modeOpt":"","modeOptType":"query","queryOpt":"payload","queryOptType":"msg","paramsOpt":"","paramsOptType":"none","rows":"rows","rowsType":"msg","params":[],"x":1210,"y":1540,"wires":[[]]},{"id":"5b2c599a.76ffa8","type":"debug","z":"1bd17114.208f7f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2130,"y":240,"wires":[]},{"id":"b9fd2aae.207e58","type":"debug","z":"1bd17114.208f7f","name":"Log for db write","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1950,"y":720,"wires":[]},{"id":"c2272e4a.b84688","type":"catch","z":"1bd17114.208f7f","name":"Catch API Exception","scope":["950ff7.f5988808"],"uncaught":false,"x":530,"y":1900,"wires":[["206a78b0.d9321"]]},{"id":"9c022b59.a44658","type":"counter-loop","z":"a2178b87.7d7a9","name":"","counter":"il9c022b59a44658","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"3","terminationType":"num","increment":1,"incrementType":"num","x":650,"y":260,"wires":[[],["8386d6ba.a30968"]]},{"id":"b9acf61b.0ec928","type":"inject","z":"a2178b87.7d7a9","name":"","props":[{"p":"il9c022b59a44658","v":"0","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":220,"y":280,"wires":[["9c022b59.a44658"]]},{"id":"8386d6ba.a30968","type":"function","z":"a2178b87.7d7a9","name":"","func":"msg.data = \"xx\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":520,"wires":[["ab85e1a3.342be8","9c022b59.a44658"]]},{"id":"ab85e1a3.342be8","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"data","targetType":"msg","statusVal":"","statusType":"auto","x":1530,"y":520,"wires":[]}]