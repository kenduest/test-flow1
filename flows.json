[{"id":"1bd17114.208f7f","type":"tab","label":"Gravity to API","disabled":false,"info":""},{"id":"8d2d215.047b26","type":"Gravity Server","server":"gravity2-nats","port":"4222"},{"id":"6d06e8a0.db70f","type":"Gravity Server","server":"gravity1-nats","port":"4222"},{"id":"62ea718e.c8bb5","type":"Gravity Server","server":"source-gravity-nats","port":"4222"},{"id":"5bc4d721.d177e8","type":"Gravity Server","server":"target-gravity-nats","port":"4222"},{"id":"a1b2b06d.089da","type":"nats-streaming-server","server":"gravity1-nats","port":"4222","cluster":"external-stan"},{"id":"f04213fa.c22b48","type":"MSSQL-CN","tdsVersion":"7_4","name":"Target MSSQL","server":"target-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"Brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","enableArithAbort":true},{"id":"2ca87b75.cb01dc","type":"MSSQL-CN","tdsVersion":"7_4","name":"MSSQL Source #1","server":"source-mssql1-1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"SinoPacBank","useUTC":false,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"d5cda53a.b9005","type":"MSSQL-CN","tdsVersion":"7_4","name":"MSSQL Source #2","server":"source-mssql2.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"SinoPacBank","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"79cd02d9.42f16c","type":"MSSQL-CN","tdsVersion":"7_4","name":"Kernel MSSQL","server":"kernel-mssql.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"mbroker","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"1c910e21.fc66da","type":"MSSQL-CN","tdsVersion":"7_4","name":"Target MSSQL1","server":"target-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"brobridge2","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"35b0806c.4ac0e8","type":"MSSQL-CN","tdsVersion":"7_4","name":"Report MSSQL","server":"report-mssql.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"SinoPacBank","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"6ba585bc.0efc8c","type":"MSSQL-CN","tdsVersion":"7_4","name":"target1-mssql","server":"target1-mssql","port":"1433","encyption":false,"trustServerCertificate":true,"database":"TestDB","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"c05b6da5.1f28e","type":"nats-streaming-server","server":"gravity2-nats","port":"4222","cluster":"external-stan"},{"id":"3bbccc8b.174474","type":"Gravity Server","server":"gravity1-nats.gravity-database.svc.cluster.local","port":"4222"},{"id":"15f3bf7c.30e271","type":"nats-streaming-server","server":"gravity1-nats.gravity-database.svc.cluster.local","port":"4223","cluster":"external-stan"},{"id":"1120185.4a64de8","type":"MSSQL-CN","tdsVersion":"7_4","name":"Sinopac Report DB","server":"10.11.144.120","port":"1433","encyption":true,"trustServerCertificate":true,"database":"gravity","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"f899a01d.1d8258","type":"debug","z":"1bd17114.208f7f","name":"Call API Response HTTP","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1660,"y":1280,"wires":[]},{"id":"950ff7.f5988808","type":"http request","z":"1bd17114.208f7f","name":"Message API POST","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://message-api.gfactor.svc.cluster.local/message-api/v1/notification","tls":"","persist":true,"proxy":"","authType":"","x":1590,"y":1360,"wires":[["206a78b0.d9321","f899a01d.1d8258"]]},{"id":"fcaf454e.703438","type":"switch","z":"1bd17114.208f7f","name":"Check Event","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"DeliveryPoolCreate","vt":"str"},{"t":"eq","v":"DeliveryPoolDelete","vt":"str"},{"t":"eq","v":"DeliveryPoolUpdate","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":1120,"wires":[["10915f53.5494e1"],[],[]]},{"id":"205d0e4c.77c1ba","type":"debug","z":"1bd17114.208f7f","name":"Debug Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"apayload","targetType":"msg","statusVal":"","statusType":"auto","x":1020,"y":1080,"wires":[]},{"id":"10915f53.5494e1","type":"function","z":"1bd17114.208f7f","name":"Create Full API Payload","func":"\nNumber.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\nfunction convert_datetime(value) {\n    \n    if (value == null) { return null }\n    \n    t1 = value\n    year = t1.getFullYear().zeroPad(1000).toString()\n    month = (t1.getMonth() + 1).zeroPad(10).toString()\n    day = t1.getDate().zeroPad(10).toString()\n    hour = t1.getHours().zeroPad(10).toString()\n    minute = t1.getMinutes().zeroPad(10).toString()\n    second = t1.getSeconds().zeroPad(10).toString()\n    NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n\n} \n\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\n\nmsg.payload = msg.payload.payload\n\n\n\nmsg.data_is_expired=0\n\nBookingTime=new Date(msg.payload.BookingTime)\nExpireTimeSec = msg.payload.ExpireTime \n\n\nif (ExpireTimeSec == null || ExpireTimeSec <= 0)  {\n    NewExpireTime = 86400\n   } \n\nt1 = new Date(BookingTime.getTime() +  ExpireTimeSec * 1000)\n\nif (new Date() >= t1) {\n    msg.data_is_expired=1\n}\n\nyear = t1.getFullYear().zeroPad(1000).toString()\nmonth = (t1.getMonth() + 1).zeroPad(10).toString()\nday = t1.getDate().zeroPad(10).toString()\nhour = t1.getHours().zeroPad(10).toString()\nminute = t1.getMinutes().zeroPad(10).toString()\nsecond = t1.getSeconds().zeroPad(10).toString()\nNewExpireTime = year + month + day + hour + minute + second\n\n\nNewPayload = {\n    \n    \"priority\": msg.payload.Priority || 9,\n    \"expireTime\": NewExpireTime,\n    \"msgType\": msg.payload.MsgType || null,\n    \"reqDepartment\": msg.payload.DepID || null,\n    \"reqBu\": msg.payload.Bu || null,\n    \"reqCompany\": msg.payload.Company || null,\n    \"reqChannel\": msg.payload.Channel || null,\n    \"reqObjectId\": msg.payload.ObjectID || null,\n    \"memo\": msg.payload.Memo || null,\n    \"content\": msg.payload.MsgData,\n    \"data\": [ {\n        \"customerPhone\": msg.payload.MPhoneNum,\n        \"customerId\": msg.payload.SenderID ,\n        \"customerReference\": msg.payload.Reference || null,\n        \"reqGroupId\": msg.payload.GroupID || null,\n        }\n    ]\n}\n\nmsg.payload = NewPayload\n\nmsg.deliveryUID =  convert_uuid(msg.payload.UID)\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":1160,"wires":[["205d0e4c.77c1ba","701a891f.13c298"]]},{"id":"206a78b0.d9321","type":"switch","z":"1bd17114.208f7f","name":"Check API Response","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"btwn","v":"400","vt":"num","v2":"499","v2t":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1840,"y":1360,"wires":[["5a1d672a.d52e78","eacfb53c.9c8eb"],[],[]]},{"id":"701a891f.13c298","type":"switch","z":"1bd17114.208f7f","name":"Check SMS Expired","property":"data_is_expired","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1140,"y":1160,"wires":[["85f76b59.9f60c8","4e109d76.26f76c"],["9d41a444.8f66c8"]]},{"id":"5e858370.4b4a54","type":"switch","z":"1bd17114.208f7f","name":"","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2330,"y":1600,"wires":[["b3769017.156f6"],["f7c597f4.2795b8"]]},{"id":"b3769017.156f6","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2260,"y":1820,"wires":[["eacfb53c.9c8eb"]]},{"id":"c5bf226.1745ae","type":"function","z":"1bd17114.208f7f","name":"Log Write Report DB","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Success, UID:\" + msg.deliveryUID\n} else {\n    msg.result = \"[[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2620,"y":1460,"wires":[["7cb9964c.de27e8","5e858370.4b4a54"]]},{"id":"a4686f76.2b462","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"1120185.4a64de8","name":"MSSQL Report For Error","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, Status, Message) VALUES(@DeliveryPoolUID, 1, 'SMS Message already expired before API access')\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1710,"y":1160,"wires":[["e82fa5a.9c179d8"]]},{"id":"df7383cb.9cd5f","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"1120185.4a64de8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, DeliverySendUID, Status, Message) VALUES(@DeliveryPoolUID, @DeliverySendUID, 0, @ResponseMessage)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendUID","type":"UniqueIdentifier","valueType":"msg","value":"sendUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseMessage","type":"VarChar(?)","valueType":"msg","value":"ResponseMessage","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2400,"y":1460,"wires":[["c5bf226.1745ae"]]},{"id":"9f5a3605.222b18","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"79cd02d9.42f16c","name":"MSSQL Target","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nINSERT INTO [dbo].[send_record](priority,send_time,expire_time,req_department,msgType,memo, req_bu, req_company, req_channel, req_group_id, req_object_id, req_batch_id) OUTPUT Inserted.UID VALUES(@priority, @send_time, @expire_time, @req_department, @msgType,memo, @req_bu, @req_company, @req_channel, @req_group_id, @req_object_id, @req_batch_id)\n\n\n// ----------------------------------------------------------\n// send table\n// ----------------------------------------------------------\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n// // send_record table\n\n\n// send_record_calc_section = Math.ceil(content.length / 70)\n\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"priority","type":"int","valueType":"msg","value":"gravity_payload.message.Priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"int","valueType":"msg","value":"gravity_payload.message.BookingTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_department","type":"int","valueType":"msg","value":"msg.gravity_payload.message.DepID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msgType","type":"int","valueType":"msg","value":"msg.gravity_payload.message.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_bu","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_company","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.GroupID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_object_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.ObjectID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.BatchID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":4900,"y":4320,"wires":[[]]},{"id":"4e109d76.26f76c","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":1430,"y":1120,"wires":[[],["a4686f76.2b462"]]},{"id":"eacfb53c.9c8eb","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2170,"y":1400,"wires":[[],["df7383cb.9cd5f"]]},{"id":"eac7848e.e8036","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":4510,"y":4320,"wires":[[],["9f5a3605.222b18"]]},{"id":"9d41a444.8f66c8","type":"function","z":"1bd17114.208f7f","name":"Set Post Header","func":"msg.headers = {\n    \"X-API-Key\": \"d6435296.d3df94350fc1955a5be9d7876bd1501c15ce8d05c89f246a5fb7b5076b69a4a7\"\n};\n\nmsg.requestTimeout = 1000 * 15\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1360,"y":1360,"wires":[["950ff7.f5988808"]]},{"id":"d38c299d.762cf","type":"debug","z":"1bd17114.208f7f","name":"Display setUID","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"sendUID","targetType":"msg","statusVal":"","statusType":"auto","x":2440,"y":1280,"wires":[]},{"id":"28dfc911.f39766","type":"debug","z":"1bd17114.208f7f","name":"Display DeliveryUID","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"deliveryUID","targetType":"msg","statusVal":"","statusType":"auto","x":2450,"y":1320,"wires":[]},{"id":"f394c4c7.c05e","type":"nats-streaming-subscribe","z":"1bd17114.208f7f","name":"Gravity Source","server":"a1b2b06d.089da","channel":"rowData.source.DeliveryPool","clientID":"atomic-01","start":"all","start_option":"","durable":true,"durable_name":"atomic-01","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"25","rate_limit":true,"max_in_flight":"1","x":220,"y":1120,"wires":[["697c97fa.1b2138"]]},{"id":"697c97fa.1b2138","type":"json","z":"1bd17114.208f7f","name":"","property":"payload","action":"","pretty":false,"x":390,"y":1120,"wires":[["fcaf454e.703438","58c29ec7.a4ffa8"]]},{"id":"52fd4830.92acc8","type":"function","z":"1bd17114.208f7f","name":"Console DB Expired Error Log Finally","func":"msg.result = \"Could not write expired data log finally\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2870,"y":2800,"wires":[["9cb4a288.d89e5"]]},{"id":"9ae77b89.722a58","type":"debug","z":"1bd17114.208f7f","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3250,"y":3120,"wires":[]},{"id":"c07e256e.51ec","type":"switch","z":"1bd17114.208f7f","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3130,"y":2920,"wires":[["60e57f74.272698"],["6778c8f5.ba8b48"]]},{"id":"60e57f74.272698","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2920,"y":3120,"wires":[["9ae77b89.722a58","d536794a.8ba4b8"]]},{"id":"6778c8f5.ba8b48","type":"function","z":"1bd17114.208f7f","name":"write success","func":"msg.result = \"Write Expire Log success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3400,"y":2920,"wires":[["9cb4a288.d89e5"]]},{"id":"9cb4a288.d89e5","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3800,"y":2800,"wires":[]},{"id":"b02409c7.93cd88","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"1120185.4a64de8","name":"MSSQL Report For Error","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status) VALUES(@DeliveryPoolUID, 2)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2890,"y":2920,"wires":[["c07e256e.51ec"]]},{"id":"d536794a.8ba4b8","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2510,"y":2820,"wires":[["52fd4830.92acc8"],["b02409c7.93cd88"]]},{"id":"9be3e2f7.f1477","type":"function","z":"1bd17114.208f7f","name":"Already Expire SMS","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2400,"y":2440,"wires":[[]]},{"id":"da036e2e.1973b8","type":"switch","z":"1bd17114.208f7f","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":2490,"y":2600,"wires":[[]]},{"id":"58c29ec7.a4ffa8","type":"debug","z":"1bd17114.208f7f","name":"Debug NAT event","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":550,"y":1040,"wires":[]},{"id":"85f76b59.9f60c8","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"","x":1300,"y":1020,"wires":[]},{"id":"f7c597f4.2795b8","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"","x":2580,"y":1600,"wires":[]},{"id":"5a1d672a.d52e78","type":"function","z":"1bd17114.208f7f","name":"Log HTTP Response","func":"\nmsg.sendUID = msg.payload.sendUid;\nmsg.ResponseMessage = JSON.stringify(msg.payload)\n\n\nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] HTTP via Message API success, Delivery DB UID: \" + msg.send_table_uid + \"API setUID: \" + msg.sendUID\n} else {\n    msg.result = \"[[GRAVITY][ATOMIC] HTTP via Message API success failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2080,"y":1280,"wires":[["d38c299d.762cf","28dfc911.f39766"]]},{"id":"e82fa5a.9c179d8","type":"function","z":"1bd17114.208f7f","name":"Check Result","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] SMS Delivery via API Server Success, UID:\" + msg.deliveryUID\n} else {\n    msg.result = \"[[GRAVITY][ATOMIC] SMS Delivery via API Server Faulure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1940,"y":1160,"wires":[["a83f5380.dd3dd8"]]},{"id":"13ad1895.c4b5a7","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1940,"y":980,"wires":[["4e109d76.26f76c"]]},{"id":"a83f5380.dd3dd8","type":"switch","z":"1bd17114.208f7f","name":"","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2150,"y":1160,"wires":[["13ad1895.c4b5a7"],[]]},{"id":"7cb9964c.de27e8","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2860,"y":1380,"wires":[]}]