[{"id":"1bd17114.208f7f","type":"tab","label":"流程1","disabled":false,"info":""},{"id":"3fc67bb7.c65944","type":"tab","label":"流程2","disabled":false,"info":""},{"id":"a2178b87.7d7a9","type":"tab","label":"流程3","disabled":false,"info":""},{"id":"8d2d215.047b26","type":"Gravity Server","server":"gravity2-nats","port":"4222"},{"id":"bbfa5c7.d0b342","type":"MSSQL-CN","name":"Target MSSQL Database","server":"target-mssql1.gravity-demo.svc.cluster.local","encyption":true,"database":"Brobridge2"},{"id":"6d06e8a0.db70f","type":"Gravity Server","server":"gravity1-nats","port":"4222"},{"id":"df8c0b88.91b0a8","type":"MSSQL-CN","name":"Dev","server":"localhost","encyption":false,"database":"Dev"},{"id":"712b53e5.990dfc","type":"mqtt-broker","broker":"localhost","port":"1883","clientid":"NodeRedSQLClient","usetls":false,"compatmode":true,"keepalive":"15","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"ce7c2fc5.bbfd68","type":"Gravity Subscriber","z":"1bd17114.208f7f","name":"Gravity1 Source Event","server":"6d06e8a0.db70f","subscriberID":"","enabledAuth":false,"initialLoad":false,"collections":[],"x":140,"y":1060,"wires":[["5e997637.8b4f58","fcaf454e.703438"]]},{"id":"f899a01d.1d8258","type":"debug","z":"1bd17114.208f7f","name":"Debug HTTP","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1150,"y":1280,"wires":[]},{"id":"950ff7.f5988808","type":"http request","z":"1bd17114.208f7f","name":"Message API POST","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://message-api.gfactor.svc.cluster.local/message-api/v1/notificationX","tls":"","persist":false,"proxy":"","authType":"","x":720,"y":1120,"wires":[["f899a01d.1d8258","e4743865.e6c888"]]},{"id":"5e997637.8b4f58","type":"debug","z":"1bd17114.208f7f","name":"Debug NATS1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":160,"y":880,"wires":[]},{"id":"fcaf454e.703438","type":"switch","z":"1bd17114.208f7f","name":"Check Event","property":"payload.eventName","propertyType":"msg","rules":[{"t":"eq","v":"DeliveryPoolCreate","vt":"str"},{"t":"eq","v":"DeliveryPoolDelete","vt":"str"},{"t":"eq","v":"DeliveryPoolUpdate","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":390,"y":1180,"wires":[["10915f53.5494e1"],[],[]]},{"id":"205d0e4c.77c1ba","type":"debug","z":"1bd17114.208f7f","name":"Debug DataFormater","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":920,"y":860,"wires":[]},{"id":"10915f53.5494e1","type":"function","z":"1bd17114.208f7f","name":"Create Data Formatter","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nBookingTime=new Date(msg.payload.message.BookingTime)\nExpireTime = msg.payload.message.ExpireTime\nt1 = new Date(BookingTime.getTime() +  ExpireTime * 1000)\nyear = t1.getFullYear().zeroPad(1000).toString()\nmonth = (t1.getMonth() + 1).zeroPad(10).toString()\nday = t1.getDate().zeroPad(10).toString()\nhour = t1.getHours().zeroPad(10).toString()\nminute = t1.getMinutes().zeroPad(10).toString()\nsecond = t1.getSeconds().zeroPad(10).toString()\n\nNewExpireTime = year + month + day + hour + minute + second\n\nmsg.payload = {\n    \"priority\": msg.payload.message.Priority,\n    \"expireTime\": NewExpireTime,\n    \"msgType\": msg.payload.message.MsgType,\n    \"reqDepartment\": msg.payload.message.DepID,\n    \"reqBu\": msg.payload.message.Bu,\n    \"reqCompany\": msg.payload.message.Company,\n    \"reqChannel\": msg.payload.message.Channel,\n    \"reqObjectId\": msg.payload.message.ObjectID,\n    \"memo\": msg.payload.message.Memo,\n    \"content\": msg.payload.message.MsgData,\n    \"data\": [ {\n        \"customerPhone\": msg.payload.message.MPhoneNum,\n        \"customerId\": msg.payload.message.SenderID,\n        \"customerReference\": msg.payload.message.Reference,\n        \"reqGroupId\": msg.payload.message.GroupID,\n        }\n    ]\n}\n\n\nmsg.retry_times = 0\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":920,"wires":[["205d0e4c.77c1ba","950ff7.f5988808"]]},{"id":"7352c592.828614","type":"Gravity Subscriber","z":"1bd17114.208f7f","name":"Gravity2 Source","server":"8d2d215.047b26","subscriberID":"","enabledAuth":false,"initialLoad":false,"collections":[],"x":140,"y":1480,"wires":[["fee80668.b66168","db41adf9.16c018"]]},{"id":"8fbb7b60.1537b","type":"Gravity Acknowledge","z":"1bd17114.208f7f","name":"Gravity1 Finish Event","x":1160,"y":960,"wires":[]},{"id":"fee80668.b66168","type":"debug","z":"1bd17114.208f7f","name":"Debug NATS2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":140,"y":1220,"wires":[]},{"id":"4e494a91.cbe4d4","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"bbfa5c7.d0b342","name":"Target MSSQL","query":"","outField":"payload","x":820,"y":1460,"wires":[["5d77224b.5e1814"]]},{"id":"f9688bd1.b81b7","type":"inject","z":"1bd17114.208f7f","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Inject","payloadType":"str","x":390,"y":1300,"wires":[["ff78ef54.3c5778"]]},{"id":"5d77224b.5e1814","type":"debug","z":"1bd17114.208f7f","name":"Debug MSSQL","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1120,"y":1380,"wires":[]},{"id":"15237651.20281a","type":"debug","z":"3fc67bb7.c65944","name":"","active":true,"console":"false","complete":"payload","x":770,"y":320,"wires":[]},{"id":"84df0cd4.58462","type":"inject","z":"3fc67bb7.c65944","name":"Select","repeat":"","crontab":"","once":false,"topic":"","payload":"SELECT TOP (1) [Topic]       ,[Payload]   FROM [Dev].[dbo].[MQTTData]","payloadType":"str","x":171.00000381469727,"y":253.99999809265137,"wires":[["eac3e9b1.b2f0e8"]]},{"id":"eac3e9b1.b2f0e8","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"df8c0b88.91b0a8","name":"MSSQL","query":"","outField":"payload","x":539,"y":321,"wires":[["15237651.20281a"]]},{"id":"ca03c5dc.709628","type":"inject","z":"3fc67bb7.c65944","name":"Insert","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"INSERT INTO [Dev].[dbo].[MQTTData] (Topic, Payload) VALUES ('Cardinal', 'Tom B. Erichsen' )","payloadType":"str","x":173,"y":305,"wires":[["eac3e9b1.b2f0e8"]]},{"id":"57a3215a.12b8d","type":"inject","z":"3fc67bb7.c65944","name":"Update","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":170,"y":356,"wires":[["fc1afd38.1ad0f"]]},{"id":"fc1afd38.1ad0f","type":"function","z":"3fc67bb7.c65944","name":"Function","func":"d = new Date,\ndformat = [d.getMonth()+1,\n    d.getDate(),\n    d.getFullYear()].join('/')+' '+\n    [d.getHours(),\n    d.getMinutes(),\n    d.getSeconds()].join(':');\n\ndtstmp = new Date().toString();\npld =       \"UPDATE [Dev].[dbo].[MQTTData] \"\npld = pld + \"Set Timestamp = '\" + dformat + \"' \"\npld = pld + \"WHERE id = 1\"\n\nmsg.payload = pld\nreturn msg;\n\n\n\n\n","outputs":1,"noerr":0,"x":310,"y":356,"wires":[["eac3e9b1.b2f0e8"]]},{"id":"35b4a3e.f64c05c","type":"inject","z":"3fc67bb7.c65944","name":"Select","repeat":"","crontab":"","once":false,"topic":"","payload":"2","payloadType":"num","x":171,"y":412,"wires":[["1528d6ba.7db449"]]},{"id":"1528d6ba.7db449","type":"function","z":"3fc67bb7.c65944","name":"Function","func":"pld =       \"SELECT ID, Topic, Payload, Timestamp \"\npld = pld + \"FROM [Dev].[dbo].[MQTTData] \"\npld = pld + \"WHERE id = \" + msg.payload\n\nmsg.payload = pld\nreturn msg;\n\n\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":311,"y":412,"wires":[["eac3e9b1.b2f0e8"]]},{"id":"38bb7577.af1c3a","type":"mqtt in","z":"3fc67bb7.c65944","name":"","topic":"SQLTest/#","qos":"0","broker":"712b53e5.990dfc","x":162,"y":462,"wires":[["7eafa2f8.041ebc"]]},{"id":"7eafa2f8.041ebc","type":"function","z":"3fc67bb7.c65944","name":"Function","func":"d = new Date(),\ndformat = [d.getMonth()+1,\n    d.getDate(),\n    d.getFullYear()].join('/')+' '+\n    [d.getHours(),\n    d.getMinutes(),\n    d.getSeconds()].join(':');\n\npld =       \"INSERT INTO [Dev].[dbo].[MQTTData] \"\npld = pld + \"(Topic, Payload, Timestamp) \"\npld = pld + \"VALUES ('\" + msg.topic + \"', '\" + msg.payload + \"', '\" + dformat + \"')\"\n\nmsg.topic = ''\nmsg.payload = pld\nreturn msg;\n\n\n\n\n","outputs":1,"noerr":0,"x":304,"y":462,"wires":[["eac3e9b1.b2f0e8","15237651.20281a"]]},{"id":"ff78ef54.3c5778","type":"function","z":"1bd17114.208f7f","name":"Insert Data","func":"\n\nmsg.payload = \"INSERT INTO [dbo].[send_record](customer_phone,content) values('12345678','content')\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":1380,"wires":[["4e494a91.cbe4d4"]]},{"id":"7afdcc2d.d44c6c","type":"catch","z":"1bd17114.208f7f","name":"","scope":["e4743865.e6c888"],"uncaught":false,"x":610,"y":1260,"wires":[["9e5d3e4f.81a16"]]},{"id":"27e61f12.c1a15","type":"inject","z":"a2178b87.7d7a9","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":930,"y":80,"wires":[["d7d08440.31b678"]]},{"id":"d7d08440.31b678","type":"function","z":"a2178b87.7d7a9","name":"Random error","func":"// Randomly throw an error rather than\n// pass on message.\nif (Math.random() < 0.5) {\n   node.error(\"a random error\", msg);\n} else {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":80,"wires":[["f22b1e9a.5d89b"]]},{"id":"f22b1e9a.5d89b","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1470,"y":160,"wires":[]},{"id":"2166290d.98d736","type":"delay","z":"a2178b87.7d7a9","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1140,"y":140,"wires":[["d7d08440.31b678"]]},{"id":"139b836e.7950ed","type":"catch","z":"a2178b87.7d7a9","name":"","scope":["d7d08440.31b678"],"uncaught":false,"x":850,"y":240,"wires":[["2166290d.98d736","9c8ab214.0ecaa"]]},{"id":"9c8ab214.0ecaa","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","x":1180,"y":240,"wires":[]},{"id":"9e5d3e4f.81a16","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":820,"y":1340,"wires":[["950ff7.f5988808"]]},{"id":"e4743865.e6c888","type":"function","z":"1bd17114.208f7f","name":"Check Result","func":"\nwhile(msg.retry_times < 2){\n\n  if (msg.statusCode != 200) {\n      msg.retry_times++;\n      node.error(\"HTTP Post Fail\", msg);\n   }\n\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":1040,"wires":[["8fbb7b60.1537b"]]},{"id":"db41adf9.16c018","type":"function","z":"1bd17114.208f7f","name":"Create Format Data","func":"\n\nmsg.payload = \"INSERT INTO [dbo].[send_record](customer_phone,content) values(\"+ \"'\" + msg.payload.message.MPhoneNum + \"','\" + msg.payload.message.MsgData + \"')\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":1480,"wires":[["4e494a91.cbe4d4"]]},{"id":"c59d0732.28f968","type":"function","z":"1bd17114.208f7f","name":"Select Data","func":"\n\nmsg.payload = \"SELECT * from [dbo].[send_record]\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":1580,"wires":[["4e494a91.cbe4d4"]]},{"id":"cc815242.78d0c","type":"inject","z":"1bd17114.208f7f","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Inject","payloadType":"str","x":330,"y":1580,"wires":[["c59d0732.28f968"]]}]