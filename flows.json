[{"id":"1bd17114.208f7f","type":"tab","label":"流程1","disabled":false,"info":""},{"id":"3fc67bb7.c65944","type":"tab","label":"流程2","disabled":false,"info":""},{"id":"a2178b87.7d7a9","type":"tab","label":"流程3","disabled":false,"info":""},{"id":"8d2d215.047b26","type":"Gravity Server","server":"gravity2-nats","port":"4222"},{"id":"6d06e8a0.db70f","type":"Gravity Server","server":"gravity1-nats","port":"4222"},{"id":"f04213fa.c22b48","type":"MSSQL-CN","tdsVersion":"7_4","name":"Target MSSQL","server":"target-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"Brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","enableArithAbort":true},{"id":"2ca87b75.cb01dc","type":"MSSQL-CN","tdsVersion":"7_4","name":"MSSQL Source #1","server":"source-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","enableArithAbort":true},{"id":"d5cda53a.b9005","type":"MSSQL-CN","tdsVersion":"7_4","name":"MSSQL Source #2","server":"source-mssql2.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"Brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","enableArithAbort":true},{"id":"79cd02d9.42f16c","type":"MSSQL-CN","tdsVersion":"7_4","name":"Target Database","server":"target-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"ce7c2fc5.bbfd68","type":"Gravity Subscriber","z":"1bd17114.208f7f","name":"Gravity1 Source Event","server":"6d06e8a0.db70f","subscriberID":"","enabledAuth":false,"initialLoad":false,"collections":[],"x":160,"y":1080,"wires":[["5e997637.8b4f58","fcaf454e.703438"]]},{"id":"f899a01d.1d8258","type":"debug","z":"1bd17114.208f7f","name":"Debug HTTP","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2210,"y":1400,"wires":[]},{"id":"950ff7.f5988808","type":"http request","z":"1bd17114.208f7f","name":"Message API POST","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://message-api.gfactor.svc.cluster.local/message-api/v1/notification","tls":"","persist":true,"proxy":"","authType":"","x":1910,"y":1520,"wires":[["206a78b0.d9321","f899a01d.1d8258"]]},{"id":"5e997637.8b4f58","type":"debug","z":"1bd17114.208f7f","name":"Debug NATS1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":400,"y":820,"wires":[]},{"id":"fcaf454e.703438","type":"switch","z":"1bd17114.208f7f","name":"Check Event","property":"payload.eventName","propertyType":"msg","rules":[{"t":"eq","v":"DeliveryPoolCreate","vt":"str"},{"t":"eq","v":"DeliveryPoolDelete","vt":"str"},{"t":"eq","v":"DeliveryPoolUpdate","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":390,"y":1200,"wires":[["10915f53.5494e1"],[],[]]},{"id":"205d0e4c.77c1ba","type":"debug","z":"1bd17114.208f7f","name":"Debug Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"api_payload","targetType":"msg","statusVal":"","statusType":"auto","x":860,"y":820,"wires":[]},{"id":"10915f53.5494e1","type":"function","z":"1bd17114.208f7f","name":"Create Full API Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nmsg.data_is_expired=0\n\nBookingTime=new Date(msg.payload.message.BookingTime)\nExpireTimeSec = msg.payload.message.ExpireTime \n\n\nif (ExpireTimeSec == null || ExpireTimeSec <= 0)  {\n    NewExpireTime = null\n   } \n\nelse {\n    t1 = new Date(BookingTime.getTime() +  ExpireTimeSec * 1000)\n\n    if (new Date() >= t1) {\n        msg.data_is_expired=1\n    }\n\n    year = t1.getFullYear().zeroPad(1000).toString()\n    month = (t1.getMonth() + 1).zeroPad(10).toString()\n    day = t1.getDate().zeroPad(10).toString()\n    hour = t1.getHours().zeroPad(10).toString()\n    minute = t1.getMinutes().zeroPad(10).toString()\n    second = t1.getSeconds().zeroPad(10).toString()\n    NewExpireTime = year + month + day + hour + minute + second\n}\n\n\nNewPayload = {\n    \n    \"priority\": msg.payload.message.Priority || 9,\n    \"expireTime\": NewExpireTime,\n    \"msgType\": msg.payload.message.MsgType || null,\n    \"reqDepartment\": msg.payload.message.DepID || null,\n    \"reqBu\": msg.payload.message.Bu || null,\n    \"reqCompany\": msg.payload.message.Company || null,\n    \"reqChannel\": msg.payload.message.Channel || null,\n    \"reqObjectId\": msg.payload.message.ObjectID || null,\n    \"memo\": msg.payload.message.Memo || null,\n    \"content\": msg.payload.message.MsgData,\n    \"data\": [ {\n        \"customerPhone\": msg.payload.message.MPhoneNum,\n        \"customerId\": msg.payload.message.SenderID ,\n        \"customerReference\": msg.payload.message.Reference || null,\n        \"reqGroupId\": msg.payload.message.GroupID || null,\n        }\n    ]\n}\n\n\nmsg.deliveryUID = msg.payload.message.UID\nmsg.api_payload = NewPayload\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":1000,"wires":[["205d0e4c.77c1ba","701a891f.13c298"]]},{"id":"fc7a311c.a37b88","type":"Gravity Subscriber","z":"3fc67bb7.c65944","name":"Gravity2 Source","server":"8d2d215.047b26","subscriberID":"","enabledAuth":false,"initialLoad":false,"collections":[],"x":260,"y":1400,"wires":[["fbb24445.6bca58","cb019b19.27d398"]]},{"id":"fbb24445.6bca58","type":"debug","z":"3fc67bb7.c65944","name":"Debug Gravity2 NATS","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":540,"y":1180,"wires":[]},{"id":"5cc04d0b.fdd6d4","type":"sqlbuilder","z":"3fc67bb7.c65944","name":"Compose Event Data","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nBookingTime=new Date(msg.payload.message.BookingTime)\nExpireTime = msg.payload.message.ExpireTime\nt1 = new Date(BookingTime.getTime() +  ExpireTime * 1000)\nyear = t1.getFullYear().zeroPad(1000).toString()\nmonth = (t1.getMonth() + 1).zeroPad(10).toString()\nday = t1.getDate().zeroPad(10).toString()\nhour = t1.getHours().zeroPad(10).toString()\nminute = t1.getMinutes().zeroPad(10).toString()\nsecond = t1.getSeconds().zeroPad(10).toString()\n\nNewExpireTime = year + month + day + hour + minute + second\n\n\n","x":800,"y":1740,"wires":[[]]},{"id":"206a78b0.d9321","type":"switch","z":"1bd17114.208f7f","name":"Check API Response","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1100,"y":1980,"wires":[["eacfb53c.9c8eb"],["4f1c1ef4.a9da6"]]},{"id":"e4c78794.60b02","type":"http request","z":"a2178b87.7d7a9","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://google.com/xxx","tls":"","persist":false,"proxy":"","authType":"","x":840,"y":700,"wires":[["fbab5c4c.b2f808"]]},{"id":"16e230dd.1abc77","type":"inject","z":"a2178b87.7d7a9","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":700,"wires":[["4c86cd88.001554"]]},{"id":"af02c4bd.3d0698","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1630,"y":1140,"wires":[]},{"id":"4c86cd88.001554","type":"function","z":"a2178b87.7d7a9","name":"create data","func":"msg.payload = { 'xx': Date().toString() }\nmsg.retry = 0\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":700,"wires":[["e4c78794.60b02"]]},{"id":"cba5ee67.f436a8","type":"counter-loop","z":"a2178b87.7d7a9","name":"For loop","counter":"retry","counterType":"msg","reset":false,"resetValue":"value-null","initial":0,"initialType":"num","operator":"gt","termination":"3","terminationType":"num","increment":1,"incrementType":"num","x":1200,"y":840,"wires":[["77524b77.59eb2c"],[]]},{"id":"77524b77.59eb2c","type":"http request","z":"a2178b87.7d7a9","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://google.com","tls":"","persist":false,"proxy":"","authType":"","x":1200,"y":1120,"wires":[["af02c4bd.3d0698","cba5ee67.f436a8"]]},{"id":"fbab5c4c.b2f808","type":"switch","z":"a2178b87.7d7a9","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":700,"wires":[["cba5ee67.f436a8"]]},{"id":"97c7cd51.742fb","type":"function","z":"1bd17114.208f7f","name":"Create API PayLoad","func":"msg.payload = msg.api_payload\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1540,"y":1520,"wires":[["5ab3489f.ec68d8","950ff7.f5988808"]]},{"id":"5ab3489f.ec68d8","type":"debug","z":"1bd17114.208f7f","name":"Debug Payload","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1780,"y":1340,"wires":[]},{"id":"c498cf27.baf6e","type":"function","z":"1bd17114.208f7f","name":"Console DB Expired Error Log Finally","func":"msg.result = \"Could not write expired data log finally\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1550,"y":160,"wires":[["5b2c599a.76ffa8"]]},{"id":"701a891f.13c298","type":"switch","z":"1bd17114.208f7f","name":"Check SMS Expired","property":"data_is_expired","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":940,"y":1000,"wires":[["4e109d76.26f76c"],["4f1c1ef4.a9da6"]]},{"id":"95a1dcb7.586838","type":"inject","z":"a2178b87.7d7a9","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Inject","payloadType":"str","x":350,"y":1520,"wires":[["a4b3e191.8e4d3"]]},{"id":"a4b3e191.8e4d3","type":"sqlbuilder","z":"a2178b87.7d7a9","name":"Query DeliveryResultLog Table","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"query.select(\"*\").from(\"DeliveryResultLog\")\n","x":630,"y":1520,"wires":[["b9eeb915.0cc6f"]]},{"id":"5fbd7021.c5ea2","type":"sqlbuilder","z":"a2178b87.7d7a9","name":"Query HandleDeliveryPool Table","field":"payload","fieldType":"msg","sqldialect":"mssql","sqlquery":"query.select(\"*\").from(\"HandleDeliveryPool\")\n","x":630,"y":1600,"wires":[["b9eeb915.0cc6f"]]},{"id":"303194a.d18236c","type":"inject","z":"a2178b87.7d7a9","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Inject","payloadType":"str","x":350,"y":1600,"wires":[["5fbd7021.c5ea2"]]},{"id":"e11a7961.e683d8","type":"debug","z":"a2178b87.7d7a9","name":"Debug Source DB Err","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"err","targetType":"msg","statusVal":"","statusType":"auto","x":1280,"y":1340,"wires":[]},{"id":"e925a296.280708","type":"function","z":"a2178b87.7d7a9","name":"","func":"node.error('EEEE')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1500,"y":1460,"wires":[[]]},{"id":"db7efe77.1508f8","type":"catch","z":"a2178b87.7d7a9","name":"","scope":["7889acb2.e45304"],"uncaught":false,"x":770,"y":1800,"wires":[["ee377bf9.0bc348"]]},{"id":"2bd6810d.e22ece","type":"catch","z":"a2178b87.7d7a9","name":"","scope":["2c94a22c.91012e"],"uncaught":false,"x":170,"y":1300,"wires":[["1b335a4f.1ca0b6","c2ade397.70a2d8"]]},{"id":"2c94a22c.91012e","type":"function","z":"a2178b87.7d7a9","name":"Random Throw Error","func":"node.error(\"XXXan example error: \");   \nreturn msg\n\nmsg.info = \"XXX\"\nmsg.il5a0b3227249654 = null\nif (Math.random() * 100 <= 50 ) {\nnode.error(\"XXXan example error: \");   \n}\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":860,"wires":[["9b74ebc8.3b67a","c2ade397.70a2d8"]]},{"id":"d16b9fac.8212a","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1020,"y":1260,"wires":[]},{"id":"c5ee9670.5dbbd8","type":"inject","z":"a2178b87.7d7a9","name":"Trigger error","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":1080,"wires":[["c2ade397.70a2d8"]]},{"id":"ee377bf9.0bc348","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1180,"y":1840,"wires":[]},{"id":"b9eeb915.0cc6f","type":"counter-loop","z":"a2178b87.7d7a9","name":"","counter":"ilb9eeb9150cc6f","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"3","terminationType":"num","increment":1,"incrementType":"num","x":930,"y":1560,"wires":[["ee377bf9.0bc348"],["59f42509.50ee7c"]]},{"id":"b02773c1.e266b8","type":"debug","z":"a2178b87.7d7a9","name":"output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1990,"y":1820,"wires":[]},{"id":"c18d22cc.a63ca","type":"inject","z":"a2178b87.7d7a9","name":"open","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"open","payloadType":"str","x":1670,"y":1680,"wires":[["99687dff.3ddd7"]]},{"id":"f8668471.4f45f8","type":"inject","z":"a2178b87.7d7a9","name":"input","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1610,"y":1820,"wires":[["99687dff.3ddd7"]]},{"id":"56c10d38.aa25c4","type":"inject","z":"a2178b87.7d7a9","name":"trigger","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"trigger","payloadType":"str","x":1670,"y":1760,"wires":[["99687dff.3ddd7"]]},{"id":"c6fce5f0.0ad3b8","type":"inject","z":"a2178b87.7d7a9","name":"flush","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"flush","payloadType":"str","x":1670,"y":1720,"wires":[["99687dff.3ddd7"]]},{"id":"5d45eb15.7a02e4","type":"inject","z":"a2178b87.7d7a9","name":"queue","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"queue","payloadType":"str","x":1670,"y":1880,"wires":[["99687dff.3ddd7"]]},{"id":"8bc7606f.d8fed","type":"inject","z":"a2178b87.7d7a9","name":"default","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"control","payload":"default","payloadType":"str","x":1670,"y":1920,"wires":[["99687dff.3ddd7"]]},{"id":"99687dff.3ddd7","type":"q-gate","z":"a2178b87.7d7a9","name":"","controlTopic":"control","defaultState":"queueing","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","queueCmd":"queue","defaultCmd":"default","triggerCmd":"trigger","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","statusCmd":"status","maxQueueLength":"1","keepNewest":true,"qToggle":false,"persist":false,"x":1860,"y":1820,"wires":[["b02773c1.e266b8"]]},{"id":"c2ade397.70a2d8","type":"counter-loop","z":"a2178b87.7d7a9","name":"","counter":"il5a0b3227249654","counterType":"msg","reset":true,"resetValue":"value-null","initial":0,"initialType":"num","operator":"lt","termination":"10","terminationType":"num","increment":1,"incrementType":"num","x":460,"y":1080,"wires":[[],["2c94a22c.91012e"]]},{"id":"1b335a4f.1ca0b6","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":620,"y":1300,"wires":[]},{"id":"9b74ebc8.3b67a","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"info","targetType":"msg","statusVal":"","statusType":"auto","x":800,"y":1220,"wires":[]},{"id":"a4686f76.2b462","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"2ca87b75.cb01dc","name":"MSSQL Source For Error","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status ) VALUES(@DeliveryPoolUID, @Status)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"int","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Status","type":"int","valueType":"num","value":"2","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1650,"y":480,"wires":[["1d4b6fb5.6c7ab8"]]},{"id":"59f42509.50ee7c","type":"MSSQL","z":"a2178b87.7d7a9","mssqlCN":"2ca87b75.cb01dc","name":"","outField":"payload","returnType":0,"throwErrors":1,"query":"","modeOpt":"","modeOptType":"query","queryOpt":"payload","queryOptType":"msg","paramsOpt":"","paramsOptType":"none","rows":"rows","rowsType":"msg","params":[],"x":1210,"y":1540,"wires":[[]]},{"id":"b9fd2aae.207e58","type":"debug","z":"1bd17114.208f7f","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2010,"y":860,"wires":[]},{"id":"b9acf61b.0ec928","type":"inject","z":"a2178b87.7d7a9","name":"","props":[{"p":"index","v":"0","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":220,"y":280,"wires":[["b603047.b9de878"]]},{"id":"b603047.b9de878","type":"loop","z":"a2178b87.7d7a9","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"3000","loopPayload":"loop-index","finalPayload":"final-last","x":470,"y":280,"wires":[[],["8d9022be.3a4cf8"]]},{"id":"4e109d76.26f76c","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":1250,"y":480,"wires":[["c498cf27.baf6e"],["a4686f76.2b462"]]},{"id":"8d9022be.3a4cf8","type":"MSSQL","z":"a2178b87.7d7a9","mssqlCN":"2ca87b75.cb01dc","name":"MSSQL Source For Error","outField":"payload","returnType":0,"throwErrors":"0","query":"SELECT * FROM dbo.DeliveryResultLogX\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"none","rows":"rows","rowsType":"msg","params":[],"x":730,"y":400,"wires":[["bfcb1a4d.f1f01","18340560.6d26e3"]]},{"id":"bfcb1a4d.f1f01","type":"debug","z":"a2178b87.7d7a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1040,"y":200,"wires":[]},{"id":"18340560.6d26e3","type":"switch","z":"a2178b87.7d7a9","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":630,"y":580,"wires":[["b603047.b9de878"]]},{"id":"1d4b6fb5.6c7ab8","type":"switch","z":"1bd17114.208f7f","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1970,"y":480,"wires":[["90417eb4.4e1268"],["fc98be46.9c05a"]]},{"id":"90417eb4.4e1268","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1660,"y":840,"wires":[["b9fd2aae.207e58","4e109d76.26f76c"]]},{"id":"fc98be46.9c05a","type":"function","z":"1bd17114.208f7f","name":"write success","func":"msg.result = \"Write Expire Log success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2300,"y":620,"wires":[["5b2c599a.76ffa8"]]},{"id":"4f1c1ef4.a9da6","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":1310,"y":1280,"wires":[[],["97c7cd51.742fb"]]},{"id":"5b2c599a.76ffa8","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2640,"y":160,"wires":[]},{"id":"eacfb53c.9c8eb","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":1310,"y":2740,"wires":[["aacbba08.c9e578"],["df7383cb.9cd5f"]]},{"id":"df7383cb.9cd5f","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"2ca87b75.cb01dc","name":"MSSQL Source For Log","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nBEGIN TRANSACTION \n\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status ) VALUES(@DeliveryPoolUID, @Status)\n\nINSERT INTO [dbo].[HandleDeliveryPool](DeliveryPoolUID ) VALUES(@DeliveryPoolUID)\n\n\nCOMMIT TRANSACTION ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"int","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Status","type":"int","valueType":"num","value":"0","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1750,"y":2980,"wires":[["5e858370.4b4a54"]]},{"id":"aacbba08.c9e578","type":"function","z":"1bd17114.208f7f","name":"Console DB Error Log Finally","func":"msg.result = \"SMS Delivery via API Server Failure\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1720,"y":2140,"wires":[["ce8e802e.11e78","d3c640e.219fb4"]]},{"id":"925c5e31.e4c0d","type":"debug","z":"1bd17114.208f7f","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2030,"y":2600,"wires":[]},{"id":"5e858370.4b4a54","type":"switch","z":"1bd17114.208f7f","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2130,"y":2980,"wires":[["b3769017.156f6"],["c5bf226.1745ae"]]},{"id":"b3769017.156f6","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1720,"y":2480,"wires":[["925c5e31.e4c0d","eacfb53c.9c8eb"]]},{"id":"c5bf226.1745ae","type":"function","z":"1bd17114.208f7f","name":"write success","func":"msg.result = \"SMS Delivery via API Server Success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2560,"y":2980,"wires":[["85b62694.daaf"]]},{"id":"85b62694.daaf","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2520,"y":2560,"wires":[]},{"id":"b3f27083.55033","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"2ca87b75.cb01dc","name":"MSSQL Source For Log","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nBEGIN TRANSACTION \n\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status ) VALUES(@DeliveryPoolUID, @Status)\n\nINSERT INTO [dbo].[HandleDeliveryPool](DeliveryPoolUID ) VALUES(@DeliveryPoolUID)\n\n\nCOMMIT TRANSACTION ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"int","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Status","type":"int","valueType":"num","value":"1","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2790,"y":2160,"wires":[["11c53d44.58cca3"]]},{"id":"d3c640e.219fb4","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2020,"y":1820,"wires":[]},{"id":"ce8e802e.11e78","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2130,"y":2140,"wires":[[],["4291760b.91d06"]]},{"id":"11c53d44.58cca3","type":"function","z":"1bd17114.208f7f","name":"write success","func":"msg.result = \"Write Un-delivery DB item\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3180,"y":2160,"wires":[["5644d003.7a6bd"]]},{"id":"5644d003.7a6bd","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3520,"y":2140,"wires":[]},{"id":"4291760b.91d06","type":"switch","z":"1bd17114.208f7f","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2530,"y":2140,"wires":[["60f6453b.0c8b74"],["b3f27083.55033"]]},{"id":"2a51cb8d.b1f3f4","type":"debug","z":"1bd17114.208f7f","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2610,"y":1640,"wires":[]},{"id":"60f6453b.0c8b74","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2360,"y":1880,"wires":[["2a51cb8d.b1f3f4","ce8e802e.11e78"]]},{"id":"ad555a9b.291b5","type":"function","z":"3fc67bb7.c65944","name":"Console DB Error Log Finally","func":"msg.result = \"Could not write expired data log finally\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1660,"y":1080,"wires":[["5bc37838.96cbf8"]]},{"id":"9d749ef4.491a18","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"d5cda53a.b9005","name":"MSSQL Source #2","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status ) VALUES(@DeliveryPoolUID, @Status)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"int","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Status","type":"int","valueType":"num","value":"3","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1770,"y":1400,"wires":[["186de65f.7fdf12"]]},{"id":"d4eadf1e.8cd08","type":"debug","z":"3fc67bb7.c65944","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2150,"y":1780,"wires":[]},{"id":"7f1a531c.e21544","type":"loop","z":"3fc67bb7.c65944","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":1370,"y":1400,"wires":[["ad555a9b.291b5"],["9d749ef4.491a18"]]},{"id":"186de65f.7fdf12","type":"switch","z":"3fc67bb7.c65944","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2110,"y":1400,"wires":[["cba9c0f8.a0369"],["4a1f8632.85cf08"]]},{"id":"cba9c0f8.a0369","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1800,"y":1760,"wires":[["d4eadf1e.8cd08","7f1a531c.e21544"]]},{"id":"4a1f8632.85cf08","type":"function","z":"3fc67bb7.c65944","name":"write success","func":"msg.result = \"Write Expire Log success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2440,"y":1540,"wires":[["5bc37838.96cbf8"]]},{"id":"5bc37838.96cbf8","type":"debug","z":"3fc67bb7.c65944","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2780,"y":1080,"wires":[]},{"id":"e9442140.4c3cd","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"2ca87b75.cb01dc","name":"MSSQL Source For Error","outField":"payload","returnType":0,"throwErrors":"0","query":"\nBEGIN TRANSACTION \n\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status ) VALUES(@DeliveryPoolUID, @Status)\n\nINSERT INTO [dbo].[HandleDeliveryPool](DeliveryPoolUID ) VALUES(@DeliveryPoolUID)\n\n\nCOMMIT TRANSACTION ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"int","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Status","type":"int","valueType":"num","value":"2","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":250,"y":1920,"wires":[[]]},{"id":"cb019b19.27d398","type":"function","z":"3fc67bb7.c65944","name":"Create Full API Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nmsg.data_is_expired=0\n\nBookingTime=new Date(msg.payload.message.BookingTime)\nExpireTimeSec = msg.payload.message.ExpireTime \n\n\nif (ExpireTimeSec == null || ExpireTimeSec <= 0)  {\n    NewExpireTime = null\n   } \n\nelse {\n    t1 = new Date(BookingTime.getTime() +  ExpireTimeSec * 1000)\n\n    if (new Date() >= t1) {\n        msg.data_is_expired=1\n    }\n\n    year = t1.getFullYear().zeroPad(1000).toString()\n    month = (t1.getMonth() + 1).zeroPad(10).toString()\n    day = t1.getDate().zeroPad(10).toString()\n    hour = t1.getHours().zeroPad(10).toString()\n    minute = t1.getMinutes().zeroPad(10).toString()\n    second = t1.getSeconds().zeroPad(10).toString()\n    NewExpireTime = year + month + day + hour + minute + second\n}\n\nmsg.send_record_calc_section = Math.ceil(msg.payload.message.MsgData.length / 70)\nmsg.sms_expire_time = NewExpireTime\nmsg.gravity_payload = msg.payload\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":1400,"wires":[["69df65b6.955c8c"]]},{"id":"5f79b2a9.76612c","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"79cd02d9.42f16c","name":"MSSQL Source #2","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status ) VALUES(@DeliveryPoolUID, @Status)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"int","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Status","type":"int","valueType":"num","value":"3","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":530,"y":1920,"wires":[[]]},{"id":"69df65b6.955c8c","type":"switch","z":"3fc67bb7.c65944","name":"Check SMS Expired","property":"data_is_expired","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":940,"y":1400,"wires":[["7f1a531c.e21544"],["c575f44c.4f1b2"]]},{"id":"50a0da5b.dbb414","type":"function","z":"3fc67bb7.c65944","name":"Console DB Error Log Finally","func":"msg.result = \"Could not sync db to kernel database\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1500,"y":2000,"wires":[["71d6f21a.d3ad04"]]},{"id":"54d1529a.a18564","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"79cd02d9.42f16c","name":"MSSQL Target","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nINSERT INTO [dbo].[send_record](priority,send_time,expire_time,req_department,msgType,memo, req_bu, req_company, req_channel, req_group_id, req_object_id, req_batch_id) OUTPUT Inserted.UID VALUES(@priority, @send_time, @expire_time, @req_department, @msgType,memo, @req_bu, @req_company, @req_channel, @req_group_id, @req_object_id, @req_batch_id)\n\n\n// ----------------------------------------------------------\n// send table\n// ----------------------------------------------------------\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n// // send_record table\n\n\n// send_record_calc_section = Math.ceil(content.length / 70)\n\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"priority","type":"int","valueType":"msg","value":"gravity_payload.message.Priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"gravity_payload.message.BookingTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_department","type":"VarChar(?)","valueType":"msg","value":"gravity_payload.message.DepID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msgType","type":"VarChar(?)","valueType":"msg","value":"gravity_payload.message.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"VarChar(?)","valueType":"msg","value":"gravity_payload.message.Memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_bu","type":"VarChar(?)","valueType":"msg","value":"gravity_payload.message.Bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_company","type":"VarChar(?)","valueType":"msg","value":"gravity_payload.message.Company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"VarChar(?)","valueType":"msg","value":"gravity_payload.message.Channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar","valueType":"msg","value":"gravity_payload.message.GroupID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_object_id","type":"VarChar","valueType":"msg","value":"gravity_payload.message.ObjectID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"VarChar","valueType":"msg","value":"gravity_payload.message.BatchID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"time","valueType":"msg","value":"sms_expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1600,"y":2320,"wires":[["eb560338.8a507"]]},{"id":"445ae4a8.fcc5c4","type":"debug","z":"3fc67bb7.c65944","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1990,"y":2700,"wires":[]},{"id":"c575f44c.4f1b2","type":"loop","z":"3fc67bb7.c65944","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":1210,"y":2320,"wires":[["50a0da5b.dbb414"],["54d1529a.a18564"]]},{"id":"eb560338.8a507","type":"switch","z":"3fc67bb7.c65944","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1950,"y":2320,"wires":[["4cf63a02.967b64"],["be637596.c9f64"]]},{"id":"4cf63a02.967b64","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1640,"y":2680,"wires":[["445ae4a8.fcc5c4","c575f44c.4f1b2"]]},{"id":"be637596.c9f64","type":"function","z":"3fc67bb7.c65944","name":"write success","func":"msg.result = \"Write Expire Log success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2280,"y":2460,"wires":[["71d6f21a.d3ad04"]]},{"id":"71d6f21a.d3ad04","type":"debug","z":"3fc67bb7.c65944","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2620,"y":2000,"wires":[]},{"id":"992d9c63.359ad","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"79cd02d9.42f16c","name":"MSSQL Target","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nINSERT INTO [dbo].[send_record](priority,send_time,expire_time,req_department,msgType,memo, req_bu, req_company, req_channel, req_group_id, req_object_id, req_batch_id) OUTPUT Inserted.UID VALUES(@priority, @send_time, @expire_time, @req_department, @msgType,memo, @req_bu, @req_company, @req_channel, @req_group_id, @req_object_id, @req_batch_id)\n\n\n// ----------------------------------------------------------\n// send table\n// ----------------------------------------------------------\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n// // send_record table\n\n\n// send_record_calc_section = Math.ceil(content.length / 70)\n\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"priority","type":"int","valueType":"msg","value":"gravity_payload.message.Priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"int","valueType":"msg","value":"gravity_payload.message.BookingTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_department","type":"int","valueType":"msg","value":"msg.gravity_payload.message.DepID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msgType","type":"int","valueType":"msg","value":"msg.gravity_payload.message.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_bu","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_company","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.GroupID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_object_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.ObjectID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.BatchID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2880,"y":3020,"wires":[["1008cd23.d4bd03"]]},{"id":"7d3825bd.9757a4","type":"debug","z":"3fc67bb7.c65944","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3270,"y":3400,"wires":[]},{"id":"ad0f410a.7e4a7","type":"loop","z":"3fc67bb7.c65944","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2490,"y":3020,"wires":[[],["992d9c63.359ad"]]},{"id":"1008cd23.d4bd03","type":"switch","z":"3fc67bb7.c65944","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3230,"y":3020,"wires":[["b380cc9.212963"],["a8440151.e83e68"]]},{"id":"b380cc9.212963","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2920,"y":3380,"wires":[["7d3825bd.9757a4","ad0f410a.7e4a7"]]},{"id":"a8440151.e83e68","type":"function","z":"3fc67bb7.c65944","name":"write success","func":"msg.result = \"Write Expire Log success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3560,"y":3160,"wires":[["eac7848e.e8036"]]},{"id":"9f5a3605.222b18","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"79cd02d9.42f16c","name":"MSSQL Target","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nINSERT INTO [dbo].[send_record](priority,send_time,expire_time,req_department,msgType,memo, req_bu, req_company, req_channel, req_group_id, req_object_id, req_batch_id) OUTPUT Inserted.UID VALUES(@priority, @send_time, @expire_time, @req_department, @msgType,memo, @req_bu, @req_company, @req_channel, @req_group_id, @req_object_id, @req_batch_id)\n\n\n// ----------------------------------------------------------\n// send table\n// ----------------------------------------------------------\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n// // send_record table\n\n\n// send_record_calc_section = Math.ceil(content.length / 70)\n\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"priority","type":"int","valueType":"msg","value":"gravity_payload.message.Priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"int","valueType":"msg","value":"gravity_payload.message.BookingTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_department","type":"int","valueType":"msg","value":"msg.gravity_payload.message.DepID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msgType","type":"int","valueType":"msg","value":"msg.gravity_payload.message.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_bu","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_company","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.GroupID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_object_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.ObjectID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.BatchID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":4220,"y":3740,"wires":[["259ad9c.846d1a6"]]},{"id":"8c503176.4fa5e","type":"debug","z":"3fc67bb7.c65944","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":4610,"y":4120,"wires":[]},{"id":"eac7848e.e8036","type":"loop","z":"3fc67bb7.c65944","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":3830,"y":3740,"wires":[[],["9f5a3605.222b18"]]},{"id":"259ad9c.846d1a6","type":"switch","z":"3fc67bb7.c65944","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":4570,"y":3740,"wires":[["6277eaa8.662124"],["b400093d.34cda"]]},{"id":"6277eaa8.662124","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":4260,"y":4100,"wires":[["8c503176.4fa5e","eac7848e.e8036"]]},{"id":"b400093d.34cda","type":"function","z":"3fc67bb7.c65944","name":"write success","func":"msg.result = \"Write Expire Log success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4900,"y":3880,"wires":[[]]}]