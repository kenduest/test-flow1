[{"id":"1bd17114.208f7f","type":"tab","label":"Gravity DB to API","disabled":false,"info":""},{"id":"dee3d9d5.f95d58","type":"tab","label":"流程1","disabled":false,"info":""},{"id":"a1b2b06d.089da","type":"nats-streaming-server","server":"gravity1-nats","port":"4222","cluster":"external-stan"},{"id":"35b0806c.4ac0e8","type":"MSSQL-CN","tdsVersion":"7_4","name":"Devel Report MSSQL","server":"report-mssql.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"gravity","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"1120185.4a64de8","type":"MSSQL-CN","tdsVersion":"7_4","name":"Sinopac Report DB","server":"10.11.144.120","port":"1433","encyption":true,"trustServerCertificate":true,"database":"gravity","useUTC":false,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"9610aff8.a70458","type":"redis-config","name":"redis-cluster:6379","options":"redis://redis-cluster:6379","cluster":false,"optionsType":"str"},{"id":"f899a01d.1d8258","type":"debug","z":"1bd17114.208f7f","name":"Call API Response HTTP","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2260,"y":1640,"wires":[]},{"id":"fcaf454e.703438","type":"switch","z":"1bd17114.208f7f","name":"Check Event","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"DeliveryPoolCreate","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":550,"y":1280,"wires":[["76cfcd36.2ae08c"],["118294b.c72fd6b"]]},{"id":"205d0e4c.77c1ba","type":"debug","z":"1bd17114.208f7f","name":"Debug Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1200,"y":1020,"wires":[]},{"id":"10915f53.5494e1","type":"function","z":"1bd17114.208f7f","name":"Create Full API Payload","func":"\n\nmsg.payload = msg.payload.payload\n\nBookingTime=new Date(msg.payload.BookingTime)\nExpireTimeSec = msg.payload.ExpireTime \n\n\nmsg.data_is_expired=0\n\nif (ExpireTimeSec == null || ExpireTimeSec <= 0)  {\n    NewExpireTime = 86400\n   } \n\nt1 = new Date(BookingTime.getTime() +  ExpireTimeSec * 1000)\n\nif (new Date() >= t1) {\n    msg.data_is_expired=1\n}\n\nNewExpireTime = convert_api_datetime(t1)\n\nmsg.DeliveryPoolUID = convert_uuid(msg.payload.UID)\n\n\nDelivery_pool_payload = {\n    \"UID\": msg.DeliveryPoolUID,\n    \"SerialNum\": msg.payload.SerialNum,\n    \"MPhoneNum\": msg.payload.MPhoneNum,\n    \"MsgData\": msg.payload.MsgData ,\n    \"Priority\": msg.payload.Priority,\n    \"BookingTime\": msg.payload.BookingTime,\n    \"ExpireTime\": msg.payload.ExpireTime ,\n    \"DepID\": msg.payload.DepID,\n    \"MsgType\":  msg.payload.MsgType,\n    \"Memo\": msg.payload.Memo ,\n    \"SenderID\": msg.payload.SenderID,\n    \"Bu\": msg.payload.Bu,\n    \"Company\": msg.payload.Company ,\n    \"Channel\": msg.payload.Channel,\n    \"Reference\": msg.payload.Reference,\n    \"RequestUID\": msg.payload.RequestUID,\n    \"ObjectID\": msg.payload.ObjectID\n}\n\n\nNewPayload = {\n    \n    \"priority\": msg.payload.Priority ,\n    \"expireTime\": NewExpireTime,\n    \"msgType\": msg.payload.MsgType || \"\",\n    \"reqDepartment\": msg.payload.DepID || \"\",\n    \"reqBu\": msg.payload.Bu || \"\",\n    \"reqCompany\": msg.payload.Company || \"\",\n    \"reqChannel\": msg.payload.Channel || \"\",\n    \"reqObjectId\": msg.payload.ObjectID || \"\",\n    \"memo\": msg.payload.Memo || \"\",\n    \"content\": msg.payload.MsgData || \"\",\n    \"data\": [ {\n        \"customerPhone\": msg.payload.MPhoneNum || \"\",\n        \"customerId\": msg.payload.SenderID || \"\",\n        \"customerReference\": msg.payload.Reference || \"\",\n        \"reqGroupId\": msg.payload.GroupID || \"\",\n        \"reqUid\": msg.RequestUID || \"\"\n        }\n    ]\n}\n\nmsg.payload = NewPayload\n\nreturn msg\n","outputs":1,"noerr":0,"initialize":"// 部署節點後，此處的程式碼將運行一次。 \n\nNumber.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\nfunction convert_datetime(value) {\n    \n    if (value == null) { return null }\n    \n    t1 = value\n    year = t1.getFullYear().zeroPad(1000).toString()\n    month = (t1.getMonth() + 1).zeroPad(10).toString()\n    day = t1.getDate().zeroPad(10).toString()\n    hour = t1.getHours().zeroPad(10).toString()\n    minute = t1.getMinutes().zeroPad(10).toString()\n    second = t1.getSeconds().zeroPad(10).toString()\n    v = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n    return v\n} \n\nfunction convert_api_datetime(value) {\n    \n    if (value == null) { return null }\n    \n    t1 = value\n    year = t1.getFullYear().zeroPad(1000).toString()\n    month = (t1.getMonth() + 1).zeroPad(10).toString()\n    day = t1.getDate().zeroPad(10).toString()\n    hour = t1.getHours().zeroPad(10).toString()\n    minute = t1.getMinutes().zeroPad(10).toString()\n    second = t1.getSeconds().zeroPad(10).toString()\n    v = year + month + day + hour + minute + second\n    return v\n} \n\n\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\n","finalize":"","libs":[],"x":930,"y":1180,"wires":[["205d0e4c.77c1ba","701a891f.13c298","e71170ec.0127a"]]},{"id":"206a78b0.d9321","type":"switch","z":"1bd17114.208f7f","name":"Check API Response","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2240,"y":1880,"wires":[["5a1d672a.d52e78"],["6e5d7fdc.09a498"]]},{"id":"701a891f.13c298","type":"switch","z":"1bd17114.208f7f","name":"Check SMS Expired","property":"data_is_expired","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1460,"y":1180,"wires":[["4e109d76.26f76c","35f19fa6.46a6a","85f76b59.9f60c8"],["9d41a444.8f66c8"]]},{"id":"5e858370.4b4a54","type":"switch","z":"1bd17114.208f7f","name":"","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3630,"y":1900,"wires":[["b3769017.156f6"],[]]},{"id":"b3769017.156f6","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3140,"y":2020,"wires":[["eacfb53c.9c8eb"]]},{"id":"c5bf226.1745ae","type":"function","z":"1bd17114.208f7f","name":"Log Write Report DB","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Success\"\n    code = 0\n    level = 'INFO'\n\n    msg.payload = {\n        \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n        \"level\": level,\n        \"code\": code,\n        \"msg\": msg.result,\n        \"time\": (new Date()).toJSON(),\n        \"payload\": { \n            \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n            \"SendUID\": msg.SendUID,\n            \"SendRecordUID\": msg.SendRecordUID,\n        }\n   }\n\n    \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Failure\"\n    msg.have_error = 1\n    level = 'ERROR'\n    code = 5304\n\n    msg.payload = {\n        \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n        \"level\": level,\n        \"code\": code,\n        \"msg\": msg.result,\n        \"time\": (new Date()).toJSON(),\n        \"payload\": { \n            \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n            \"SendUID\": msg.SendUID,\n            \"SendRecordUID\": msg.SendRecordUID,\n            \"error\": msg.error\n        }\n   }\n    \n}\n\n\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3380,"y":1800,"wires":[["7cb9964c.de27e8","5e858370.4b4a54","65d34139.3de0c8","9ebd2a20.bf725"]]},{"id":"a4686f76.2b462","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[deliveryresultlog] \n            (deliverypooluid, \n             status, \n             message, \n             sourcetype) \nVALUES      (@DeliveryPoolUID, \n             5301, \n             'SMS Message already expired before API access', \n             'Realtime'\n             ) ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"DeliveryPoolUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2040,"y":1160,"wires":[["fe3ae2f3.5288e"]]},{"id":"df7383cb.9cd5f","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, SendUID, SendRecordUID, Status, Message, SourceType) VALUES(@DeliveryPoolUID, @DeliverySendUID, @DeliverySendRecordUID, @ResponseStatus, @ResponseMessage, 'Realtime')\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"VarChar(?)","valueType":"msg","value":"DeliveryPoolUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendUID","type":"VarChar(?)","valueType":"msg","value":"SendUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendRecordUID","type":"VarChar(?)","valueType":"msg","value":"SendRecordUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseMessage","type":"NVarChar(?)","valueType":"msg","value":"ResponseMessage","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseStatus","type":"int","valueType":"msg","value":"ResponseStatus","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3120,"y":1860,"wires":[["c5bf226.1745ae"]]},{"id":"4e109d76.26f76c","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":1810,"y":1160,"wires":[[],["a4686f76.2b462"]]},{"id":"eacfb53c.9c8eb","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2870,"y":1860,"wires":[[],["8bd8332e.77edd"]]},{"id":"9d41a444.8f66c8","type":"function","z":"1bd17114.208f7f","name":"Set Post Header","func":"\nmsg.headers = {\n    \"X-API-Key\": \"d6435296.d3df94350fc1955a5be9d7876bd1501c15ce8d05c89f246a5fb7b5076b69a4a7\"\n};\n\nmsg.requestTimeout = 1000 * 15\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1740,"y":1640,"wires":[["7dd61989.93a4a"]]},{"id":"d38c299d.762cf","type":"debug","z":"1bd17114.208f7f","name":"Display sendUID","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"sendUID","targetType":"msg","statusVal":"","statusType":"auto","x":2910,"y":1700,"wires":[]},{"id":"28dfc911.f39766","type":"debug","z":"1bd17114.208f7f","name":"Display DeliveryUID","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"deliveryUID","targetType":"msg","statusVal":"","statusType":"auto","x":2920,"y":1740,"wires":[]},{"id":"f394c4c7.c05e","type":"nats-streaming-subscribe","z":"1bd17114.208f7f","name":"Gravity Source","server":"a1b2b06d.089da","channel":"rowData.source.DeliveryPool","clientID":"source1-atomic-001","start":"all","start_option":"","durable":true,"durable_name":"source1-atomic-001","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"25","rate_limit":true,"max_in_flight":"1","x":140,"y":1220,"wires":[["697c97fa.1b2138"]]},{"id":"697c97fa.1b2138","type":"json","z":"1bd17114.208f7f","name":"","property":"payload","action":"","pretty":false,"x":330,"y":1220,"wires":[["fcaf454e.703438","58c29ec7.a4ffa8"]]},{"id":"58c29ec7.a4ffa8","type":"debug","z":"1bd17114.208f7f","name":"Debug NAT event","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":550,"y":1140,"wires":[]},{"id":"5a1d672a.d52e78","type":"function","z":"1bd17114.208f7f","name":"Log HTTP Response","func":"\nmsg.ResponseMessage = msg.payload\nmsg.ResponseStatus = 0\nmsg.SendUID = JSON.parse(msg.payload)[\"sendUid\"]\n\nmsg.SendRecordUID = JSON.parse(msg.payload)[\"results\"][0][\"sendRecordUid\"] || null\n\nmsg.result = \"[GRAVITY][ATOMIC] HTTP Post via Message API success\"\n\nmsg.payload = {\n    \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n    \"level\": \"INFO\",\n    \"code\": 0,\n    \"msg\": msg.result,\n    \"time\": (new Date()).toJSON(),\n    \"payload\": {\n        \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n        \"SendUID\": msg.SendUID,\n        \"SendRecordUID\": msg.SendRecordUID\n    }\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2520,"y":1860,"wires":[["d38c299d.762cf","28dfc911.f39766","eacfb53c.9c8eb","2c9233fb.fd9efc","9b98c796.aa0568"]]},{"id":"13ad1895.c4b5a7","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2120,"y":1380,"wires":[["4e109d76.26f76c"]]},{"id":"a83f5380.dd3dd8","type":"switch","z":"1bd17114.208f7f","name":"","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2510,"y":1160,"wires":[["13ad1895.c4b5a7"],[]]},{"id":"7cb9964c.de27e8","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3740,"y":1800,"wires":[]},{"id":"6e5d7fdc.09a498","type":"function","z":"1bd17114.208f7f","name":"Log HTTP Response","func":"\nmsg.result = \"[GRAVITY][ATOMIC] HTTP via Message API failure\"\nmsg.ResponseMessage = msg.payload\nmsg.ResponseStatus = 5303\n\nmsg.payload = {\n    \"channel\": \"GRAVITY_MESSAGE_API\",\n    \"level\": \"ERROR\",\n    \"code\": msg.ResponseStatus,\n    \"message\": msg.result,\n    \"time\": (new Date()).toJSON(),\n    \"payload\": {\n        \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n        \"error\": msg.ResponseMessage\n    }\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2540,"y":2220,"wires":[["6c6fe2cb.c86474","2b0af9e9.d913de","d5432e70.044a78"]]},{"id":"b857c00f.8f4b58","type":"switch","z":"1bd17114.208f7f","name":"","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":3070,"y":2660,"wires":[["efb42dca.7e907"]]},{"id":"efb42dca.7e907","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2840,"y":2760,"wires":[["2b0af9e9.d913de"]]},{"id":"3f338f22.4d30d","type":"function","z":"1bd17114.208f7f","name":"Log Write Report DB","func":"\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Success\"\n    msg.have_error = 0\n    code = 0\n    level = \"INFO\"\n\n    \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Failure\"\n    msg.have_error = 1\n    code = 5304\n    level = \"ERROR\"\n}\n\nmsg.payload = {\n    \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n    \"level\": level,\n    \"code\": code,\n    \"msg\": msg.result,\n    \"time\": (new Date()).toJSON(),\n    \"payload\": { \n        \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n        \"error\": msg.error\n    }\n}\n\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3260,"y":2520,"wires":[["4e824f07.5e5c38","b857c00f.8f4b58","cb29d8eb.5857d","85259d79.f1d17"]]},{"id":"b846afcd.53a52","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[deliveryresultlog]\n            (deliverypooluid,\n             status,\n             message,\n             sourcetype)\nVALUES      (@DeliveryPoolUID,\n             @ResponseStatus,\n             @ResponseMessage,\n             'Realtime')","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"DeliveryPoolUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseMessage","type":"NVarChar(?)","valueType":"msg","value":"ResponseMessage","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseStatus","type":"int","valueType":"msg","value":"ResponseStatus","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3040,"y":2520,"wires":[["3f338f22.4d30d"]]},{"id":"2b0af9e9.d913de","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2790,"y":2520,"wires":[[],["b846afcd.53a52"]]},{"id":"4e824f07.5e5c38","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3500,"y":2520,"wires":[]},{"id":"6c6fe2cb.c86474","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2860,"y":2320,"wires":[]},{"id":"e71170ec.0127a","type":"debug","z":"1bd17114.208f7f","name":"Debug DeliveryPoolUID","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"DeliveryPoolUID","targetType":"msg","statusVal":"","statusType":"auto","x":1230,"y":1100,"wires":[]},{"id":"35f19fa6.46a6a","type":"function","z":"1bd17114.208f7f","name":"Log Expired Information","func":"\nmsg.result = \"[GRAVITY][ATOMIC]HTTP via Message API failure, SMS is already expired\"\n\n\nmsg.payload = {\n    \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n    \"code\": 5301,\n    \"level\": \"ERROR\",\n    \"msg\": msg.result,\n    \"time\": (new Date()).toJSON(),\n    \"payload\": {\n        \"DeliveryPoolUID\":  msg.DeliveryPoolUID\n    }\n}\n\nreturn msg\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1830,"y":920,"wires":[["f2fbc7f9.c43248","fea35dd1.6db93"]]},{"id":"f2fbc7f9.c43248","type":"debug","z":"1bd17114.208f7f","name":"Display Expired Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2150,"y":920,"wires":[]},{"id":"7dd61989.93a4a","type":"http request","z":"1bd17114.208f7f","name":"API Post","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://message-api.gfactor.svc.cluster.local/message-api/v1/notification","tls":"","persist":true,"proxy":"","authType":"","x":2000,"y":1640,"wires":[["f899a01d.1d8258","206a78b0.d9321"]]},{"id":"118294b.c72fd6b","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"ACK","x":730,"y":1320,"wires":[]},{"id":"fea35dd1.6db93","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":2150,"y":860,"wires":[]},{"id":"d5432e70.044a78","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":2890,"y":2220,"wires":[]},{"id":"cb29d8eb.5857d","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":3570,"y":2380,"wires":[]},{"id":"9ebd2a20.bf725","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":3730,"y":1680,"wires":[]},{"id":"2c9233fb.fd9efc","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":2930,"y":1640,"wires":[]},{"id":"acd077a.4edb588","type":"redis-in","z":"1bd17114.208f7f","d":true,"server":"9610aff8.a70458","command":"subscribe","name":"Query Redis","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"timeout":"3","x":150,"y":1520,"wires":[["dec0b9f9.fe26d"]]},{"id":"dec0b9f9.fe26d","type":"debug","z":"1bd17114.208f7f","name":"Display Redis Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":480,"y":1520,"wires":[]},{"id":"89312ec5.436ce","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":2550,"y":1020,"wires":[]},{"id":"76cfcd36.2ae08c","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"0.2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":760,"y":1240,"wires":[["10915f53.5494e1"]]},{"id":"85259d79.f1d17","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"ACK","x":3490,"y":2460,"wires":[]},{"id":"65d34139.3de0c8","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"ACK","x":3730,"y":1740,"wires":[]},{"id":"85f76b59.9f60c8","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"ACK","x":1770,"y":1060,"wires":[]},{"id":"fe3ae2f3.5288e","type":"function","z":"1bd17114.208f7f","name":"Log Write Report DB","func":"\nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Success\"\n    msg.have_error = 0\n    \n    level = 'INFO'\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Failure\"\n    msg.have_error = 1\n    level = 'ERROR'\n    code = 5304\n    \n}\n\nmsg.payload = {\n    \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n    \"level\": level,\n    \"code\": code,\n    \"msg\": msg.result,\n    \"time\": (new Date()).toJSON(),\n    \"payload\": { \n        \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n        \"error\": msg.error\n    }\n}\n\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2260,"y":1160,"wires":[["89312ec5.436ce","a83f5380.dd3dd8","ef10b1f1.8e7fe"]]},{"id":"ef10b1f1.8e7fe","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2500,"y":1080,"wires":[]},{"id":"9b98c796.aa0568","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2900,"y":1780,"wires":[]},{"id":"8bd8332e.77edd","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"BEGIN\n    BEGIN TRANSACTION;\n\n    INSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, SendUID, SendRecordUID, Status, Message, SourceType) VALUES(@DeliveryPoolUID, @DeliverySendUID, @DeliverySendRecordUID, @ResponseStatus, @ResponseMessage, 'Realtime')\n\n    INSERT INTO [dbo].[deliverypoolrealtime]\n                (UID,\n                 SerialNum,\n                 MPhoneNum,\n                 MsgData,\n                 Priority,\n                 BookingTime,\n                 ExpireTime,\n                 DepID,\n                 MsgType,\n                 Memo,\n                 SenderID,\n                 Bu,\n                 Company,\n                 Channel,\n                 Reference,\n                 RequestUID,\n                 ObjectID)\n    VALUES      ( @DeliverySendRecordUID,\n                  @DeliveryPoolSerialNum,\n                  @DeliveryPoolMPhoneNum,\n                  @DeliveryPoolMsgData,\n                  @DeliveryPoolPriority,\n                  @DeliveryPoolBookingTime,\n                  @DeliveryPoolExpireTime,\n                  @DeliveryPoolDepID,\n                  @DeliveryPoolMsgType,\n                  @DeliveryPoolMemo,\n                  @DeliveryPoolSenderID,\n                  @DeliveryPoolBu,\n                  @DeliveryPoolCompany,\n                  @DeliveryPoolChannel,\n                  @DeliveryPoolReference,\n                  @DeliveryPoolRequestUID,\n                  @DeliveryPoolObjectID)\n\n    COMMIT;\nEND ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"DeliveryPoolUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendUID","type":"UniqueIdentifier","valueType":"msg","value":"SendUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendRecordUID","type":"UniqueIdentifier","valueType":"msg","value":"SendRecordUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolSerialNum","type":"int","valueType":"msg","value":"delivery_pool_payload.SerialNum","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolMPhoneNum","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.MPhoneNum","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolMsgData","type":"NVarChar(?)","valueType":"msg","value":"delivery_pool_payload.MsgData","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolPriority","type":"int","valueType":"msg","value":"delivery_pool_payload.Priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolBookingTime","type":"DateTime","valueType":"msg","value":"delivery_pool_payload.BookingTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolExpireTime","type":"int","valueType":"msg","value":"delivery_pool_payload.ExpireTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolDepID","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.DepID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolMsgType","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolMemo","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.Memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolSenderID","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.SenderID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolBu","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.Bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolCompany","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.Company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolChannel","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.Channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolReference","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.Reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolRequestUID","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.RequestUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolObjectID","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.ObjectID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliveryPoolBatchID","type":"VarChar(?)","valueType":"msg","value":"delivery_pool_payload.BatchID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseMessage","type":"NVarChar(?)","valueType":"msg","value":"ResponseMessage","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseStatus","type":"int","valueType":"msg","value":"ResponseStatus","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3140,"y":1760,"wires":[["c5bf226.1745ae"]]}]