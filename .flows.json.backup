[{"id":"1bd17114.208f7f","type":"tab","label":"N-流程1","disabled":false,"info":""},{"id":"3fc67bb7.c65944","type":"tab","label":"N-流程2","disabled":false,"info":""},{"id":"8d2d215.047b26","type":"Gravity Server","server":"gravity2-nats","port":"4222"},{"id":"6d06e8a0.db70f","type":"Gravity Server","server":"gravity1-nats","port":"4222"},{"id":"62ea718e.c8bb5","type":"Gravity Server","server":"source-gravity-nats","port":"4222"},{"id":"5bc4d721.d177e8","type":"Gravity Server","server":"target-gravity-nats","port":"4222"},{"id":"a1b2b06d.089da","type":"nats-streaming-server","server":"gravity1-nats","port":"4222","cluster":"external-stan"},{"id":"f04213fa.c22b48","type":"MSSQL-CN","tdsVersion":"7_4","name":"Target MSSQL","server":"target-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"Brobridge","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","enableArithAbort":true},{"id":"2ca87b75.cb01dc","type":"MSSQL-CN","tdsVersion":"7_4","name":"MSSQL Source #1","server":"source-mssql1-1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"SinoPacBank","useUTC":false,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"d5cda53a.b9005","type":"MSSQL-CN","tdsVersion":"7_4","name":"MSSQL Source #2","server":"source-mssql2.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"SinoPacBank","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"79cd02d9.42f16c","type":"MSSQL-CN","tdsVersion":"7_4","name":"Kernel MSSQL","server":"kernel-mssql.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"mbroker","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"1c910e21.fc66da","type":"MSSQL-CN","tdsVersion":"7_4","name":"Target MSSQL1","server":"target-mssql1.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"brobridge2","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"35b0806c.4ac0e8","type":"MSSQL-CN","tdsVersion":"7_4","name":"Report MSSQL","server":"report-mssql.gravity-demo.svc.cluster.local","port":"1433","encyption":true,"trustServerCertificate":true,"database":"SinoPacBank","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"6ba585bc.0efc8c","type":"MSSQL-CN","tdsVersion":"7_4","name":"target1-mssql","server":"target1-mssql","port":"1433","encyption":false,"trustServerCertificate":true,"database":"TestDB","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"c05b6da5.1f28e","type":"nats-streaming-server","server":"gravity2-nats","port":"4222","cluster":"external-stan"},{"id":"f899a01d.1d8258","type":"debug","z":"1bd17114.208f7f","name":"Debug HTTP","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3170,"y":1660,"wires":[]},{"id":"950ff7.f5988808","type":"http request","z":"1bd17114.208f7f","name":"Message API POST","method":"POST","ret":"txt","paytoqs":"ignore","url":"http://message-api.gfactor.svc.cluster.local/message-api/v1/notification","tls":"","persist":true,"proxy":"","authType":"","x":2850,"y":1660,"wires":[["206a78b0.d9321","f899a01d.1d8258"]]},{"id":"5e997637.8b4f58","type":"debug","z":"1bd17114.208f7f","name":"Debug NATS1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":440,"y":1360,"wires":[]},{"id":"fcaf454e.703438","type":"switch","z":"1bd17114.208f7f","name":"Check Event","property":"payload.eventName","propertyType":"msg","rules":[{"t":"eq","v":"DeliveryPoolCreate","vt":"str"},{"t":"eq","v":"DeliveryPoolDelete","vt":"str"},{"t":"eq","v":"DeliveryPoolUpdate","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1090,"y":1300,"wires":[["c7c45ecf.a85fe"],[],[]]},{"id":"205d0e4c.77c1ba","type":"debug","z":"1bd17114.208f7f","name":"Debug Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"api_payload","targetType":"msg","statusVal":"","statusType":"auto","x":1800,"y":1600,"wires":[]},{"id":"10915f53.5494e1","type":"function","z":"1bd17114.208f7f","name":"Create Full API Payload","func":"\nNumber.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nmsg.data_is_expired=0\n\nBookingTime=new Date(msg.payload.message.BookingTime)\nExpireTimeSec = msg.payload.message.ExpireTime \n\n\nif (ExpireTimeSec == null || ExpireTimeSec <= 0)  {\n    NewExpireTime = null\n   } \n\nelse {\n    t1 = new Date(BookingTime.getTime() +  ExpireTimeSec * 1000)\n\n    if (new Date() >= t1) {\n        msg.data_is_expired=1\n    }\n\n    year = t1.getFullYear().zeroPad(1000).toString()\n    month = (t1.getMonth() + 1).zeroPad(10).toString()\n    day = t1.getDate().zeroPad(10).toString()\n    hour = t1.getHours().zeroPad(10).toString()\n    minute = t1.getMinutes().zeroPad(10).toString()\n    second = t1.getSeconds().zeroPad(10).toString()\n    NewExpireTime = year + month + day + hour + minute + second\n}\n\n\nNewPayload = {\n    \n    \"priority\": msg.payload.message.Priority || 9,\n    \"expireTime\": NewExpireTime,\n    \"msgType\": msg.payload.message.MsgType || null,\n    \"reqDepartment\": msg.payload.message.DepID || null,\n    \"reqBu\": msg.payload.message.Bu || null,\n    \"reqCompany\": msg.payload.message.Company || null,\n    \"reqChannel\": msg.payload.message.Channel || null,\n    \"reqObjectId\": msg.payload.message.ObjectID || null,\n    \"memo\": msg.payload.message.Memo || null,\n    \"content\": msg.payload.message.MsgData,\n    \"data\": [ {\n        \"customerPhone\": msg.payload.message.MPhoneNum,\n        \"customerId\": msg.payload.message.SenderID ,\n        \"customerReference\": msg.payload.message.Reference || null,\n        \"reqGroupId\": msg.payload.message.GroupID || null,\n        }\n    ]\n}\n\n\nconst source = msg.payload.message.UID;\n\nlet raw = new Buffer.alloc(16, source, 'base64');\n\nlet p1 = raw.subarray(0, 4);\nlet p2 = raw.subarray(4, 6);\nlet p3 = raw.subarray(6, 8);\nlet p4 = raw.subarray(8, 10);\nlet p5 = raw.subarray(10);\n\nlet uuidArr = [\n p1.swap32().toString('hex'),\n p2.swap16().toString('hex'),\n p3.swap16().toString('hex'),\n p4.toString('hex'),\n p5.toString('hex')\n];\n\nmsg.deliveryUID =  uuidArr.join('-');\n\nmsg.api_payload = NewPayload\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1530,"y":1420,"wires":[["205d0e4c.77c1ba","701a891f.13c298"]]},{"id":"206a78b0.d9321","type":"switch","z":"1bd17114.208f7f","name":"Check API Response","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2160,"y":2160,"wires":[["60555572.c9111c"],["4f1c1ef4.a9da6"]]},{"id":"97c7cd51.742fb","type":"function","z":"1bd17114.208f7f","name":"Create API PayLoad","func":"msg.payload = msg.api_payload\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2340,"y":1500,"wires":[["5ab3489f.ec68d8","9d41a444.8f66c8"]]},{"id":"5ab3489f.ec68d8","type":"debug","z":"1bd17114.208f7f","name":"Debug Payload","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":2560,"y":1400,"wires":[]},{"id":"c498cf27.baf6e","type":"function","z":"1bd17114.208f7f","name":"Console DB Expired Error Log Finally","func":"msg.result = \"Could not write expired data log finally\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2550,"y":900,"wires":[["5b2c599a.76ffa8"]]},{"id":"701a891f.13c298","type":"switch","z":"1bd17114.208f7f","name":"Check SMS Expired","property":"data_is_expired","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1840,"y":1340,"wires":[["a7608f11.d4a29"],["4f1c1ef4.a9da6"]]},{"id":"b9fd2aae.207e58","type":"debug","z":"1bd17114.208f7f","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2930,"y":1220,"wires":[]},{"id":"1d4b6fb5.6c7ab8","type":"switch","z":"1bd17114.208f7f","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2810,"y":1020,"wires":[["90417eb4.4e1268"],["fc98be46.9c05a"]]},{"id":"90417eb4.4e1268","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2600,"y":1220,"wires":[["b9fd2aae.207e58","4e109d76.26f76c"]]},{"id":"fc98be46.9c05a","type":"function","z":"1bd17114.208f7f","name":"write success","func":"msg.result = \"Write Expire Log success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3080,"y":1020,"wires":[["5b2c599a.76ffa8"]]},{"id":"5b2c599a.76ffa8","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3480,"y":900,"wires":[]},{"id":"aacbba08.c9e578","type":"function","z":"1bd17114.208f7f","name":"Console DB Error Log Finally","func":"msg.result = \"SMS Delivery via API Server Failure\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2900,"y":2240,"wires":[["ce8e802e.11e78","d3c640e.219fb4"]]},{"id":"925c5e31.e4c0d","type":"debug","z":"1bd17114.208f7f","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3590,"y":2880,"wires":[]},{"id":"5e858370.4b4a54","type":"switch","z":"1bd17114.208f7f","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3650,"y":3180,"wires":[["b3769017.156f6"],["c5bf226.1745ae"]]},{"id":"b3769017.156f6","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3340,"y":2920,"wires":[["925c5e31.e4c0d","eacfb53c.9c8eb"]]},{"id":"c5bf226.1745ae","type":"function","z":"1bd17114.208f7f","name":"write success","func":"msg.result = \"SMS Delivery via API Server Success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4080,"y":3180,"wires":[["85b62694.daaf"]]},{"id":"85b62694.daaf","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":4000,"y":2880,"wires":[]},{"id":"d3c640e.219fb4","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3240,"y":2060,"wires":[]},{"id":"11c53d44.58cca3","type":"function","z":"1bd17114.208f7f","name":"write success","func":"msg.result = \"Write Un-delivery DB item\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4260,"y":2240,"wires":[["44bf32cf.3bc84c"]]},{"id":"4291760b.91d06","type":"switch","z":"1bd17114.208f7f","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3610,"y":2240,"wires":[["60f6453b.0c8b74"],["b3f27083.55033"]]},{"id":"2a51cb8d.b1f3f4","type":"debug","z":"1bd17114.208f7f","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3830,"y":1940,"wires":[]},{"id":"60f6453b.0c8b74","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3620,"y":2060,"wires":[["2a51cb8d.b1f3f4","ce8e802e.11e78"]]},{"id":"a4686f76.2b462","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report For Error","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status) VALUES(@DeliveryPoolUID, 2)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2570,"y":1020,"wires":[["1d4b6fb5.6c7ab8"]]},{"id":"df7383cb.9cd5f","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, DeliverySendUID, Status ) VALUES(@DeliveryPoolUID, @DeliverySendUID, 0)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendUID","type":"UniqueIdentifier","valueType":"msg","value":"sendUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3340,"y":3180,"wires":[["5e858370.4b4a54"]]},{"id":"b3f27083.55033","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"2ca87b75.cb01dc","name":"MSSQL Source #1 Unhanbled","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nINSERT INTO [dbo].[DeliveryUnHandleDeliveryPool](DeliveryPoolUID ) VALUES(@DeliveryPoolUID)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"BigInt","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3910,"y":2240,"wires":[["11c53d44.58cca3","ad1a89.ab18c578"]]},{"id":"9f5a3605.222b18","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"79cd02d9.42f16c","name":"MSSQL Target","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nINSERT INTO [dbo].[send_record](priority,send_time,expire_time,req_department,msgType,memo, req_bu, req_company, req_channel, req_group_id, req_object_id, req_batch_id) OUTPUT Inserted.UID VALUES(@priority, @send_time, @expire_time, @req_department, @msgType,memo, @req_bu, @req_company, @req_channel, @req_group_id, @req_object_id, @req_batch_id)\n\n\n// ----------------------------------------------------------\n// send table\n// ----------------------------------------------------------\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n// // send_record table\n\n\n// send_record_calc_section = Math.ceil(content.length / 70)\n\n\n// query.insert(\n//     {\n//         customer_phone: msg.payload.message.MPhoneNum,\n//         content: msg.payload.message.MsgData,\n//         send_time: BookingTime,\n//         expire_time: NewExpireTime,\n//         customer_id: msg.payload.message.SenderID,\n//         customer_reference: msg.payload.message.Reference,\n//         calc_section: send_record_calc_section,\n//         status:0\n        \n//     }\n// ).into('send_record').returning('uid')\n\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"priority","type":"int","valueType":"msg","value":"gravity_payload.message.Priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"int","valueType":"msg","value":"gravity_payload.message.BookingTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_department","type":"int","valueType":"msg","value":"msg.gravity_payload.message.DepID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msgType","type":"int","valueType":"msg","value":"msg.gravity_payload.message.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_bu","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_company","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"int","valueType":"msg","value":"msg.gravity_payload.message.Channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.GroupID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_object_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.ObjectID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"int","valueType":"msg","value":"msg.gravity_payload.message.BatchID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":4900,"y":4320,"wires":[[]]},{"id":"4e109d76.26f76c","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2190,"y":920,"wires":[["c498cf27.baf6e"],["a4686f76.2b462"]]},{"id":"4f1c1ef4.a9da6","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2090,"y":1500,"wires":[[],["97c7cd51.742fb"]]},{"id":"eacfb53c.9c8eb","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2930,"y":3180,"wires":[[],["df7383cb.9cd5f"]]},{"id":"ce8e802e.11e78","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":3310,"y":2260,"wires":[[],["4291760b.91d06"]]},{"id":"eac7848e.e8036","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":4510,"y":4320,"wires":[[],["9f5a3605.222b18"]]},{"id":"c7c45ecf.a85fe","type":"function","z":"1bd17114.208f7f","name":"Save API PayLoad","func":"msg.gravity_payload = msg.payload.message \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1370,"y":1300,"wires":[["10915f53.5494e1"]]},{"id":"9d41a444.8f66c8","type":"function","z":"1bd17114.208f7f","name":"","func":"msg.headers = {\n    \"X-API-Key\": \"d6435296.d3df94350fc1955a5be9d7876bd1501c15ce8d05c89f246a5fb7b5076b69a4a7\"\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2550,"y":1660,"wires":[["950ff7.f5988808"]]},{"id":"ecc0688b.751348","type":"function","z":"1bd17114.208f7f","name":"","func":"msg.sendUID = JSON.parse(msg.payload).sendUid;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2530,"y":2700,"wires":[["eacfb53c.9c8eb","d38c299d.762cf","28dfc911.f39766"]]},{"id":"d38c299d.762cf","type":"debug","z":"1bd17114.208f7f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"sendUID","targetType":"msg","statusVal":"","statusType":"auto","x":2800,"y":2640,"wires":[]},{"id":"85c12f52.79d1f8","type":"switch","z":"3fc67bb7.c65944","name":"Check Event","property":"payload.eventName","propertyType":"msg","rules":[{"t":"eq","v":"BatchDeliveryPoolCreate","vt":"str"},{"t":"eq","v":"BatchDeliveryPoolDelete","vt":"str"},{"t":"eq","v":"BatchDeliveryPoolUpdate","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1430,"y":1440,"wires":[["fa6d7907.48f6f8"],[],[]]},{"id":"3702123e.c88666","type":"function","z":"3fc67bb7.c65944","name":"Create SQL Payload","func":"function generate_uuid() {\n  var d = Date.now();\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function'){\n    d += performance.now();\n  }\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    var r = (d + Math.random() * 16) % 16 | 0;\n    d = Math.floor(d / 16);\n      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);\n  });\n}\n\n\nNumber.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nmsg.data_is_expired=0\n\nBookingTime=new Date(msg.payload.message.BookingTime)\nExpireTimeSec = msg.payload.message.ExpireTime \n\n\nt1 = BookingTime\nyear = t1.getFullYear().zeroPad(1000).toString()\nmonth = (t1.getMonth() + 1).zeroPad(10).toString()\nday = t1.getDate().zeroPad(10).toString()\nhour = t1.getHours().zeroPad(10).toString()\nminute = t1.getMinutes().zeroPad(10).toString()\nsecond = t1.getSeconds().zeroPad(10).toString()\nNewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n\n\nif (ExpireTimeSec == null || ExpireTimeSec <= 0)  {\n    NewExpireTime = null\n   } \n\nelse {\n    t1 = new Date(BookingTime.getTime() +  ExpireTimeSec * 1000)\n\n    if (new Date() >= t1) {\n        msg.data_is_expired=1\n    }\n\n    year = t1.getFullYear().zeroPad(1000).toString()\n    month = (t1.getMonth() + 1).zeroPad(10).toString()\n    day = t1.getDate().zeroPad(10).toString()\n    hour = t1.getHours().zeroPad(10).toString()\n    minute = t1.getMinutes().zeroPad(10).toString()\n    second = t1.getSeconds().zeroPad(10).toString()\n    NewExpireTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n}\n\n\nif (msg.payload.message.MsgData.length <= 70) {\n    calc_section = 1 } \nelse  {\n    calc_section = Math.floor(msg.payload.message.MsgData.length/70+1)\n}\n\nsend_table_uuid = generate_uuid()\nsend_record_table_uuid = generate_uuid()\n\n\nsend_table_payload = {\n    \"uid\": send_table_uuid,\n    \"send_from\": 2,\n    \"status\": 4,\n    \"send_time\": NewSendTime,\n    \"priority\": msg.payload.message.Priority || 9,\n    \"expire_time\": NewExpireTime,\n    \"msg_type\": msg.payload.message.MsgType || \"\",\n    \"req_department\": msg.payload.message.DepID || \"\",\n    \"req_bu\": msg.payload.message.Bu || \"\",\n    \"req_company\": msg.payload.message.Company || \"\",\n    \"req_channel\": msg.payload.message.Channel || \"\",\n    \"req_object_id\": msg.payload.message.ObjectID || \"\",\n    \"memo\": msg.payload.message.Memo || \"\",\n    \"req_batch_id\": msg.payload.message.BatchID || \"\",\n    \"req_group_id\": msg.payload.message.GroupID || \"\",\n    \"calc_section\": calc_section,\n    \"req_req_department\": msg.payload.message.DepID || \"\"\n    \n}\n\nsend_record_table_payload = {\n    \"uid\": send_record_table_uuid,\n    \"status\": 0,\n    \"send_uid\": send_table_uuid,\n    \"serial_number\": msg.payload.message.SerialNum || 0,\n    \"customer_phone\": msg.payload.message.MPhoneNum,\n    \"content\": msg.payload.message.MsgData || \"\",\n    \"send_time\": BookingTime,\n    \"expire_time\": NewExpireTime,\n    \"customer_id\": msg.payload.message.SenderID ,\n    \"customer_reference\": msg.payload.message.Reference || \"\",\n\n}\n\n\nchannel_payload = {\n    \"send_record_uid\": send_record_table_uuid,\n    \"priority\": msg.payload.message.Priority || 9,\n    \"phone\": msg.payload.message.MPhoneNum,\n    \"content\": msg.payload.message.MsgData || \"\",\n    \"send_time\": NewSendTime,\n    \"expire_time\": NewExpireTime,\n    \"msg_type\": msg.payload.message.MsgType || \"\",\n    \"req_object_id\": msg.payload.message.ObjectID || \"\",\n    \"req_group_id\": msg.payload.message.GroupID || \"\",\n    \"req_channel\": msg.payload.message.Channel || \"\",\n}\n\n\nconst source = msg.payload.message.UID;\n\nlet raw = new Buffer.alloc(16, source, 'base64');\n\nlet p1 = raw.subarray(0, 4);\nlet p2 = raw.subarray(4, 6);\nlet p3 = raw.subarray(6, 8);\nlet p4 = raw.subarray(8, 10);\nlet p5 = raw.subarray(10);\n\nlet uuidArr = [\n p1.swap32().toString('hex'),\n p2.swap16().toString('hex'),\n p3.swap16().toString('hex'),\n p4.toString('hex'),\n p5.toString('hex')\n];\n\n\nmsg.payload.send_table_payload = send_table_payload\nmsg.payload.send_record_table_payload = send_record_table_payload\nmsg.payload.channel_payload = channel_payload\nmsg.deliveryUID =  uuidArr.join('-');\nmsg.deliverySendUID = send_table_uuid\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1840,"y":1700,"wires":[["d2899891.30de9","a53e66ab.7e6ed"]]},{"id":"d2899891.30de9","type":"switch","z":"3fc67bb7.c65944","name":"Check SMS Expired","property":"data_is_expired","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2240,"y":1400,"wires":[[],["59f09f82.b2d898"]]},{"id":"db6bf7bc.f4c188","type":"function","z":"3fc67bb7.c65944","name":"Console DB Expired Error Log Finally","func":"msg.result = \"Could not write result data log finally\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2830,"y":740,"wires":[["1bc481d1.d3f926"]]},{"id":"1b739c9.c2486e3","type":"debug","z":"3fc67bb7.c65944","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3270,"y":1360,"wires":[]},{"id":"4dd6a8d6.1087c","type":"switch","z":"3fc67bb7.c65944","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3250,"y":1060,"wires":[["505bfe8b.637d48"],["77a5264d.0a3ef"]]},{"id":"505bfe8b.637d48","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2940,"y":1420,"wires":[["1b739c9.c2486e3","94bcba97.a560a"]]},{"id":"77a5264d.0a3ef","type":"function","z":"3fc67bb7.c65944","name":"write success","func":"msg.result = \"Write Report DB For Expire success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3580,"y":1080,"wires":[["1bc481d1.d3f926","21292512.44f65a"]]},{"id":"1bc481d1.d3f926","type":"debug","z":"3fc67bb7.c65944","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3920,"y":740,"wires":[]},{"id":"7c48d622.3d2018","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID,Status ) VALUES(@DeliveryPoolUID, 2)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2980,"y":1060,"wires":[["4dd6a8d6.1087c"]]},{"id":"94bcba97.a560a","type":"loop","z":"3fc67bb7.c65944","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2610,"y":1060,"wires":[["db6bf7bc.f4c188"],["7c48d622.3d2018"]]},{"id":"59f09f82.b2d898","type":"loop","z":"3fc67bb7.c65944","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2490,"y":1620,"wires":[["21292512.44f65a"],["7c94660c.3ef47"]]},{"id":"7c94660c.3ef47","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"79cd02d9.42f16c","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"BEGIN TRANSACTION;\n\nINSERT INTO [adbo].[send](send_mode, way_name, uid, send_from, status, send_time, priority, expire_time, msg_type, req_department, req_bu, req_company, req_channel, req_object_id, memo,req_batch_id) VALUES('','SMS', @send_uid, @send_from, @send_status, @send_time, @priority, @expire_time, @msg_type, @req_department, @req_bu, @req_company, @req_channel, @req_object_id, @memo, @req_batch_id)\n\nINSERT INTO [adbo].[send_record](way_name, status, uid, send_uid, serial_number, customer_phone, content, send_time, expire_time, customer_id, customer_reference, req_group_id ) VALUES('SMS', @send_record_status, @send_record_uid, @send_uid, @serial_number, @customer_phone, @content, @send_time, @expire_time, @customer_id, @customer_reference, @req_group_id)\n\nINSERT INTO [adbo].{{{global.current_channel_db_name}}}(status, way_name, send_uid, send_record_uid, priority, phone, content, send_time,expire_time, msg_type, req_object_id, req_group_id, req_channel, req_department) VALUES(0, '', @send_uid, @send_record_uid, @priority, @phone, @content, @send_time, @expire_time, @msg_type, @req_object_id, @req_group_id, @req_channel, @req_department)\n\n\nCOMMIT;\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_table_payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_from","type":"Int","valueType":"msg","value":"payload.send_table_payload.send_from","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_status","type":"Int","valueType":"msg","value":"payload.send_table_payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_table_payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"priority","type":"Int","valueType":"msg","value":"payload.send_table_payload.priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.send_table_payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_type","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.msg_type","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_department","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.req_department","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_bu","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.req_bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_company","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.req_company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.req_channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_object_id","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.req_object_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.req_batch_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.send_table_payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"Int","valueType":"msg","value":"payload.send_table_payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_record_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_record_table_payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.send_record_table_payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.send_record_table_payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"VarChar(?)","valueType":"msg","value":"payload.send_record_table_payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.send_record_table_payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.send_record_table_payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"phone","type":"VarChar(?)","valueType":"msg","value":"payload.channel_payload.phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_record_status","type":"int","valueType":"msg","value":"payload.send_record_table_payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2660,"y":2100,"wires":[["eabd47e2.85756","f1d3938f.fca558"]]},{"id":"eabd47e2.85756","type":"debug","z":"3fc67bb7.c65944","name":"Debug Payload","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3010,"y":1900,"wires":[]},{"id":"fa6d7907.48f6f8","type":"function","z":"3fc67bb7.c65944","name":"Random DB Channel ID","func":"\nif (global.current_channel_db_id == null) {\n  global.set(\"current_channel_db_id\", 0);\n  global.set(\"current_channel_db_name\", \"channel_0\");\n}\n\nelse if (global.current_channel_db_id == 0) {\n  global.set(\"current_channel_db_id\", 1);\n  global.set(\"current_channel_db_name\", \"channel_1\");\n    \n}\n\nelse {\n  global.set(\"current_channel_db_id\", 0);\n  global.set(\"current_channel_db_name\", \"channel_0\");\n\n}\n\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1850,"y":1420,"wires":[["3702123e.c88666"]]},{"id":"ad1a89.ab18c578","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, DeliverySendUID, Status ) VALUES(@DeliveryPoolUID, @DeliverySendUID, 0)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"BigInt","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendUID","type":"UniqueIdentifier","valueType":"msg","value":"sendUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":4320,"y":2440,"wires":[["44bf32cf.3bc84c"]]},{"id":"c1a8a89e.674e78","type":"function","z":"3fc67bb7.c65944","name":"Console DB Expired Error Log Finally","func":"msg.result = \"Could not write result data log finally\"\n\nif (msg.error != null) {\n    msg.result += \": \" + msg.error\n\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3490,"y":2240,"wires":[["a8c3f514.826f78"]]},{"id":"e6c283de.191fa","type":"debug","z":"3fc67bb7.c65944","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3990,"y":2880,"wires":[]},{"id":"e40df524.4d7de8","type":"switch","z":"3fc67bb7.c65944","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3990,"y":2540,"wires":[["ac67fffe.cf5f68"],["55011bd5.658d2c"]]},{"id":"ac67fffe.cf5f68","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3680,"y":2900,"wires":[["e6c283de.191fa","a17a291.aae3fd8"]]},{"id":"55011bd5.658d2c","type":"function","z":"3fc67bb7.c65944","name":"write success","func":"msg.result = \"Write Result Log success\"\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4320,"y":2680,"wires":[["a8c3f514.826f78","21292512.44f65a"]]},{"id":"a8c3f514.826f78","type":"debug","z":"3fc67bb7.c65944","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":4160,"y":2240,"wires":[]},{"id":"a17a291.aae3fd8","type":"loop","z":"3fc67bb7.c65944","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":3310,"y":2540,"wires":[["c1a8a89e.674e78"],["1ba9f9f6.b9382e"]]},{"id":"1ba9f9f6.b9382e","type":"MSSQL","z":"3fc67bb7.c65944","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, DeliverySendUID, Status ) VALUES(@DeliveryPoolUID, @DeliverySendUID, 0)\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"deliveryUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendUID","type":"UniqueIdentifier","valueType":"msg","value":"deliverySendUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3640,"y":2540,"wires":[["e40df524.4d7de8"]]},{"id":"21292512.44f65a","type":"function","z":"3fc67bb7.c65944","name":"All Done","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4500,"y":1260,"wires":[[]]},{"id":"5e5eef3d.765cb","type":"q-gate","z":"3fc67bb7.c65944","d":true,"name":"q-gate","controlTopic":"control","defaultState":"queueing","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","queueCmd":"queue","defaultCmd":"default","triggerCmd":"trigger","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","statusCmd":"status","maxQueueLength":"0","keepNewest":false,"qToggle":false,"persist":false,"x":2670,"y":4120,"wires":[[]]},{"id":"44bf32cf.3bc84c","type":"debug","z":"1bd17114.208f7f","name":"Display db write result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":4740,"y":2180,"wires":[]},{"id":"28dfc911.f39766","type":"debug","z":"1bd17114.208f7f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"deliveryUID","targetType":"msg","statusVal":"","statusType":"auto","x":2820,"y":2700,"wires":[]},{"id":"e82c1d35.ecf818","type":"Gravity Subscriber","z":"1bd17114.208f7f","name":"Gravity1 Source Event","server":"6d06e8a0.db70f","subscriberID":"","enabledAuth":false,"initialLoad":false,"collections":["DeliveryPool"],"x":240,"y":1460,"wires":[["f1b7b544.2cdaf8","20924609.e02d12","5e997637.8b4f58"]]},{"id":"ce559453.27066","type":"function","z":"1bd17114.208f7f","name":"get next","func":"node.send({topic: \"control\", payload: \"drop\"})\nmsg.topic = \"control\"\nmsg.payload = \"peek\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":2180,"wires":[["44b29a0.ecf39e8"]]},{"id":"44b29a0.ecf39e8","type":"link out","z":"1bd17114.208f7f","name":"","links":["1406ce10.7b8862"],"x":715,"y":2180,"wires":[]},{"id":"1406ce10.7b8862","type":"link in","z":"1bd17114.208f7f","name":"","links":["44b29a0.ecf39e8"],"x":795,"y":2180,"wires":[["f1b7b544.2cdaf8"]]},{"id":"20924609.e02d12","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":440,"y":1580,"wires":[["ebc75cd.91940a"]]},{"id":"ebc75cd.91940a","type":"function","z":"1bd17114.208f7f","name":"start processing","func":"var newMsg;\nnewMsg = { \n        topic: \"control\",\n        payload: \"peek\",\n}  \n//node.log(global.get(\"ALLOW\"))\nif (global.get(\"ALLOW\") != 1) \n{\n    global.set(\"ALLOW\",  1);\n    node.status({fill: \"green\",text:\"RUN ONCE\"});\n    return newMsg;\n}\n\nreturn;","outputs":1,"noerr":0,"initialize":"// 部署節點後，此處的程式碼將運行一次。 \nglobal.set(\"ALLOW\",  0) ","finalize":"","libs":[],"x":480,"y":1720,"wires":[["f1b7b544.2cdaf8"]]},{"id":"58b38cce.1a7f1c","type":"status","z":"1bd17114.208f7f","name":"q-gate status","scope":["f1b7b544.2cdaf8"],"x":290,"y":2260,"wires":[["423831f1.928dd8"]]},{"id":"423831f1.928dd8","type":"function","z":"1bd17114.208f7f","name":"Reset","func":"if (global.get(\"ALLOW\") ==  1  && msg.status.text.replace('queuing: ', '') == '0' ){\n    global.set(\"ALLOW\",  0) \n}\n//node.log(global.get(\"ALLOW\"));\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":2260,"wires":[[]]},{"id":"cb895bbf.7b6538","type":"complete","z":"1bd17114.208f7f","name":"","scope":["60555572.c9111c","a7608f11.d4a29"],"uncaught":false,"x":290,"y":2120,"wires":[["ce559453.27066","4694a563.ec196c"]]},{"id":"f1b7b544.2cdaf8","type":"q-gate","z":"1bd17114.208f7f","name":"q-gate","controlTopic":"control","defaultState":"queueing","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","queueCmd":"queue","defaultCmd":"default","triggerCmd":"trigger","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","statusCmd":"status","maxQueueLength":"0","keepNewest":false,"qToggle":false,"persist":false,"x":830,"y":1460,"wires":[["fcaf454e.703438"]]},{"id":"4694a563.ec196c","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"","x":580,"y":1980,"wires":[]},{"id":"f394c4c7.c05e","type":"nats-streaming-subscribe","z":"1bd17114.208f7f","name":"Source","server":"a1b2b06d.089da","channel":"rowData.source.DeliveryPool","clientID":"atomic-01","start":"all","start_option":"","durable":true,"durable_name":"atomic-01","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"5","rate_limit":true,"max_in_flight":"1","x":370,"y":1120,"wires":[["697c97fa.1b2138"]]},{"id":"697c97fa.1b2138","type":"json","z":"1bd17114.208f7f","name":"","property":"payload","action":"","pretty":false,"x":690,"y":1140,"wires":[["fcaf454e.703438"]]},{"id":"56e49599.27247c","type":"inject","z":"1bd17114.208f7f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":2000,"wires":[["4694a563.ec196c"]]},{"id":"60555572.c9111c","type":"function","z":"1bd17114.208f7f","name":"HTTP Success Request","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2270,"y":2320,"wires":[["ecc0688b.751348"]]},{"id":"a7608f11.d4a29","type":"function","z":"1bd17114.208f7f","name":"Already Expire SMS","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":1180,"wires":[["4e109d76.26f76c"]]},{"id":"6d764386.4b9c5c","type":"inject","z":"1bd17114.208f7f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":250,"y":2400,"wires":[["423831f1.928dd8"]]},{"id":"c3c43bd4.4b4818","type":"debug","z":"3fc67bb7.c65944","name":"Debug NATS1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":720,"y":1500,"wires":[]},{"id":"8a8442fd.4262e","type":"Gravity Subscriber","z":"3fc67bb7.c65944","name":"Gravity2 Source Event","server":"8d2d215.047b26","subscriberID":"","enabledAuth":false,"initialLoad":false,"collections":["BatchDeliveryPool"],"x":520,"y":1600,"wires":[["fd6ae1d9.a5cf48","22c24dc8.85d5ba","c3c43bd4.4b4818"]]},{"id":"3617674d.ab3938","type":"function","z":"3fc67bb7.c65944","name":"get next","func":"node.send({topic: \"control\", payload: \"drop\"})\nmsg.topic = \"control\"\nmsg.payload = \"peek\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":2320,"wires":[["95bdc9f0.76ff4"]]},{"id":"95bdc9f0.76ff4","type":"link out","z":"3fc67bb7.c65944","name":"","links":["c198a5e8.c3e58","60130cbb.4ca634"],"x":995,"y":2320,"wires":[]},{"id":"c198a5e8.c3e58","type":"link in","z":"3fc67bb7.c65944","name":"","links":["95bdc9f0.76ff4"],"x":1075,"y":2320,"wires":[["fd6ae1d9.a5cf48"]]},{"id":"22c24dc8.85d5ba","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":720,"y":1720,"wires":[["5cf4b67a.0d0a2"]]},{"id":"5cf4b67a.0d0a2","type":"function","z":"3fc67bb7.c65944","name":"start processing","func":"var newMsg;\nnewMsg = { \n        topic: \"control\",\n        payload: \"peek\",\n}  \n//node.log(global.get(\"ALLOW\"))\nif (global.get(\"ALLOW\") != 1) \n{\n    global.set(\"ALLOW\",  1);\n    node.status({fill: \"green\",text:\"RUN ONCE\"});\n    return newMsg;\n}\n\nreturn;","outputs":1,"noerr":0,"initialize":"// 部署節點後，此處的程式碼將運行一次。 \nglobal.set(\"ALLOW\",  0) ","finalize":"","libs":[],"x":840,"y":1860,"wires":[["fd6ae1d9.a5cf48"]]},{"id":"d70c9ea8.83e9a","type":"status","z":"3fc67bb7.c65944","name":"q-gate status","scope":["fd6ae1d9.a5cf48"],"x":570,"y":2500,"wires":[["654a0854.e2bab"]]},{"id":"654a0854.e2bab","type":"function","z":"3fc67bb7.c65944","name":"Reset","func":"if (global.get(\"ALLOW\") ==  1  && msg.status.text.replace('queuing: ', '') == '0' ){\n    global.set(\"ALLOW\",  0) \n}\n//node.log(global.get(\"ALLOW\"));\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":2500,"wires":[[]]},{"id":"e72a9888.c3c428","type":"complete","z":"3fc67bb7.c65944","name":"","scope":["a06cff31.d4286","c221a39f.a1aba"],"uncaught":false,"x":570,"y":2260,"wires":[["3617674d.ab3938","72dcb32c.83b904"]]},{"id":"fd6ae1d9.a5cf48","type":"q-gate","z":"3fc67bb7.c65944","name":"q-gate","controlTopic":"control","defaultState":"queueing","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","queueCmd":"queue","defaultCmd":"default","triggerCmd":"trigger","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","statusCmd":"status","maxQueueLength":"0","keepNewest":false,"qToggle":false,"persist":false,"x":1110,"y":1600,"wires":[["85c12f52.79d1f8"]]},{"id":"72dcb32c.83b904","type":"nats-streaming-acknowledge","z":"3fc67bb7.c65944","name":"","x":860,"y":2120,"wires":[]},{"id":"6f537e65.37e448","type":"nats-streaming-subscribe","z":"3fc67bb7.c65944","name":"Source","server":"c05b6da5.1f28e","channel":"rowData.source.BatchDeliveryPool","clientID":"atomic-01","start":"all","start_option":"","durable":true,"durable_name":"atomic-01","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"5","rate_limit":true,"max_in_flight":"1","x":650,"y":1260,"wires":[["5b46e9fc.f74198"]]},{"id":"5b46e9fc.f74198","type":"json","z":"3fc67bb7.c65944","name":"","property":"payload","action":"","pretty":false,"x":970,"y":1280,"wires":[["85c12f52.79d1f8"]]},{"id":"f8a59376.934d58","type":"inject","z":"3fc67bb7.c65944","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":500,"y":2140,"wires":[["72dcb32c.83b904"]]},{"id":"9aef8691.ee2c18","type":"inject","z":"3fc67bb7.c65944","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":530,"y":2640,"wires":[["654a0854.e2bab"]]},{"id":"a06cff31.d4286","type":"function","z":"3fc67bb7.c65944","name":"Already Expire SMS","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2280,"y":1140,"wires":[["94bcba97.a560a"]]},{"id":"f1d3938f.fca558","type":"switch","z":"3fc67bb7.c65944","name":"","property":"error","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2790,"y":2340,"wires":[["b30c9c28.0b49e8"],["c221a39f.a1aba"]]},{"id":"b30c9c28.0b49e8","type":"delay","z":"3fc67bb7.c65944","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2260,"y":2740,"wires":[["fcc4b574.ea179","59f09f82.b2d898"]]},{"id":"fcc4b574.ea179","type":"debug","z":"3fc67bb7.c65944","name":"Log for db write error","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2630,"y":2740,"wires":[]},{"id":"c221a39f.a1aba","type":"function","z":"3fc67bb7.c65944","name":"Already Update Kernel","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3000,"y":2540,"wires":[["a17a291.aae3fd8"]]},{"id":"a53e66ab.7e6ed","type":"debug","z":"3fc67bb7.c65944","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2110,"y":1700,"wires":[]},{"id":"1d821c17.bbe7cc","type":"complete","z":"3fc67bb7.c65944","name":"","scope":["21292512.44f65a"],"uncaught":false,"x":570,"y":2360,"wires":[["3617674d.ab3938"]]}]